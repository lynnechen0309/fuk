<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡å¥½å¥½ç© - è¡Œç¨‹èˆ‡æ¸…å–®</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN for visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ (æ—¥ç³»ç°¡ç´„ï¼Œéš±è—æ»¾å‹•æ¢) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* å®šç¾©éæ¸¡å‹•ç•« */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Increased z-index */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 420px;
            max-height: 90vh; /* Prevent modal from being too tall */
            overflow-y: auto; /* Allow scrolling within modal */
            transform: translateY(-30px);
            transition: transform 0.3s ease;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); 
        }
        .modal-backdrop.open .modal-content {
            transform: translateY(0);
        }
        /* Sub-item specific styles */
        .sub-item-checkbox:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }
    </style>
</head>
<!-- <body> èƒŒæ™¯å·²èª¿æ•´ç‚º bg-pink-50 (éå¸¸æ·¡çš„ç«ç‘°ç²‰) -->
<body class="bg-pink-50 antialiased h-screen flex flex-col">

    <!-- ä¸»å®¹å™¨ï¼šå¯¬åº¦å—é™ä¸¦å±…ä¸­ï¼Œæ¨¡æ“¬æ‰‹æ©Ÿ App ä»‹é¢ -->
    <div id="app" class="max-w-md mx-auto bg-white h-full flex flex-col font-sans text-gray-800 shadow-2xl overflow-hidden relative">
        
        <!-- Header: æŸ”å’ŒèŠ±å‰æ¼¸å±¤ -->
        <div id="header" class="bg-gradient-to-br from-rose-400 to-pink-300 p-6 text-white shrink-0 shadow-lg z-20">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">ç¦å²¡æ«»èŠ±ç´€è¡Œ</h1>
                    <p class="text-pink-100 text-sm mt-1">4/6 - 4/9 â€¢ 4å¤©3å¤œ</p>
                </div>
                <!-- åœ°åœ–åœ–æ¨™ï¼šæ¡ç”¨ç™½è‰²åº•è‰²ï¼ŒæŸ”å’Œç²‰è‰²å¤–æ¡† -->
                <div class="p-2 rounded-xl border border-white/40 backdrop-blur-sm">
                    <i data-lucide="map-pin" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Area: èƒŒæ™¯å·²èª¿æ•´ç‚º bg-pink-50 -->
        <div id="main-content" class="scroll-container z-10 bg-pink-50">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <!-- Bottom Navigation: ç°¡ç´„çš„ç™½è‰²å°èˆª -->
        <div id="navigation" class="bg-white border-t border-gray-100 shrink-0 w-full flex justify-around items-center h-16 z-30 shadow-t-lg">
            <!-- Navigation buttons will be rendered here by JavaScript -->
        </div>
        
        <!-- ============================================== -->
        <!-- Modal Structure (æ–°å¢/ç·¨è¼¯å‚™è¨»å…±ç”¨) -->
        <!-- ============================================== -->
        <div id="modal-backdrop" class="modal-backdrop" onclick="closeModal(event)">
            <div id="modal-content" class="modal-content" onclick="event.stopPropagation()">
                <!-- Modal content will be injected here -->
            </div>
        </div>

    </div>

    <script>
        // ====================================================================
        // 1. DATA AND STATE MANAGEMENT (æ•¸æ“šå’Œç‹€æ…‹ç®¡ç†)
        // ====================================================================

        const STORAGE_KEY = 'fukuokaTripData_v6_images'; 

        let activeTab = 'itinerary'; // itinerary, ferry, packing
        let activeDay = 1;
        let tempImageBase64 = ''; // æš«å­˜ä¸Šå‚³çš„åœ–ç‰‡ Base64
        
        // åˆå§‹è¡Œææ¸…å–®è³‡æ–™
        const initialPackingList = [
            {
                category: 'æ–‡ä»¶èˆ‡é‡‘éŒ¢',
                items: [
                    { id: 'p1', text: 'è­·ç…§ (æœ‰æ•ˆæœŸé™6å€‹æœˆä»¥ä¸Š)', checked: false },
                    { id: 'p2', text: 'æ—¥å¹£ç¾é‡‘ (å±‹å°èˆ‡æ¸¡è¼ªåªæ”¶ç¾é‡‘)', checked: false },
                    { id: 'p3', text: 'æ©Ÿç¥¨/ä½å®¿é è¨‚ç¢ºèªå–®', checked: false },
                ]
            },
            {
                category: 'é›»å­ç”¢å“èˆ‡å……é›»',
                items: [
                    { id: 'p4', text: 'ç¶²å¡ / SIMå¡ / æ¼«éŠ', checked: false },
                    { id: 'p5', text: 'è¡Œå‹•é›»æº & å……é›»ç·š', checked: false },
                    { id: 'p6', text: 'è½‰æ¥é ­ (æ—¥æœ¬é›™å­”æ‰æ’)', checked: false },
                ]
            },
            {
                category: 'è¡£ç‰©èˆ‡å€‹äººç”¨å“',
                items: [
                    { id: 'p7', text: 'èˆ’é©å¥½èµ°çš„é‹ (å¤ªå®°åºœ/è²“å³¶)', checked: false },
                    { id: 'p8', text: 'è¼•ä¾¿é›¨å…· / æ‘ºç–Šå‚˜', checked: false },
                    { id: 'p9', text: 'å€‹äººç›¥æ´—ç”¨å“èˆ‡åŒ–å¦å“', checked: false },
                    { id: 'p12', text: 'æ›æ´—è¡£ç‰©', checked: false },
                ]
            },
            {
                category: 'è—¥å“èˆ‡å…¶ä»–',
                items: [
                    { id: 'p10', text: 'å€‹äººå¸¸å‚™è—¥å“ (æ„Ÿå†’è—¥ã€è…¸èƒƒè—¥)', checked: false },
                    { id: 'p11', text: 'æšˆèˆ¹è—¥ (å¾€è²“å³¶å‚™ç”¨)', checked: false },
                    { id: 'p13', text: 'è¼•ä¾¿ä¿æº«ç“¶', checked: false },
                ]
            }
        ];
        let packingList = [];

        // åˆå§‹è¡Œç¨‹è³‡æ–™
        const initialItineraryData = [
            {
                day: 1, date: "4/6 (ä¸€)", title: "æŠµé”ç¦å²¡ & åšå¤šç¾é£Ÿä¹‹å¤œ",
                activities: [
                    { 
                        id: 'd1a1', time: "16:00", title: "æŠµé”ç¦å²¡æ©Ÿå ´ (FUK)", 
                        description: "è¾¦ç†å…¥å¢ƒæ‰‹çºŒï¼Œæå–è¡Œæã€‚", type: "plane", 
                        mapQuery: "Fukuoka Airport International Terminal", 
                        image: "https://placehold.co/400x120/f7f7f7/6b7280?text=Fukuoka+Airport", 
                        notes: "å…¥å¢ƒå¯©æŸ¥å¯èƒ½æ’éšŠï¼Œé ç•™æ™‚é–“ã€‚",
                        subItems: [
                            { id: 's1', text: 'å¡«å¯« Visit Japan Web', checked: false },
                            { id: 's2', text: 'é ˜å–æ‰˜é‹è¡Œæ', checked: false }
                        ]
                    },
                    { 
                        id: 'd1a2', time: "17:00", title: "é£¯åº— Check-inï¼šç¦å²¡æ±æ–¹é£¯åº—", 
                        description: "é£¯åº—å°±åœ¨åšå¤šè»Šç«™ç­‘ç´«å£æ—ï¼Œäº¤é€šè¶…æ–¹ä¾¿ã€‚", type: "hotel", 
                        mapQuery: "Oriental Hotel Fukuoka Hakata Station", 
                        image: "https://placehold.co/400x120/f0f4f8/8f97a3?text=Oriental+Hotel+%7C+Hakata", 
                        notes: "å…¥ä½æ™‚é–“ï¼š15:00 å¾Œã€‚[å®˜ç¶²é€£çµ](https://www.oriental-hotels.com/)",
                        subItems: []
                    },
                    { id: 'd1a3', time: "18:30", title: "æ™šé¤ï¼šå…¼è™æ²¾éºµ (å…¼è™)", description: "ã€æœ€é †è·¯åˆ†åº—ã€‘ä½æ–¼åšå¤šè»Šç«™ DEITOS éºµè¡—é“ 2Fã€‚", type: "food", mapQuery: "Kanetora Hakata Deitos", image: "https://placehold.co/400x120/fff7e6/d97706?text=Kanetora+Tsukemen+%7C+Noodle", notes: "", subItems: [] },
                    { id: 'd1a4', time: "20:30", title: "ä¸­æ´²å±‹å°é«”é©—", description: "æ²¿è‘—é‚£ç‚å·æ•£æ­¥ï¼Œé«”é©—ç¦å²¡ç¨æœ‰çš„è·¯é‚Šæ”¤æ–‡åŒ–ã€‚", type: "sightseeing", mapQuery: "Nakasu Yatai Street", image: "https://placehold.co/400x120/fcf3f6/ec4899?text=Nakasu+Yatai+%7C+Yatai", notes: "å±‹å°åªæ”¶ç¾é‡‘ï¼", subItems: [] }
                ]
            },
            {
                day: 2, date: "4/7 (äºŒ)", title: "å¤ªå®°åºœç¥ˆç¦ & èˆé¶´åŸè³æ«»",
                activities: [
                    { id: 'd2a0', time: "09:00", title: "æ—©é¤ï¼šé£Ÿå ‚ ãŠã‚ã‚“", description: "äº«ç”¨æ—¥å¼å‚³çµ±å®šé£Ÿæ—©é¤ã€‚", type: "food", mapQuery: "é£Ÿå ‚ ãŠã‚ã‚“ Hakata", image: "https://placehold.co/400x120/fff7e6/d97706?text=Shokudou+Owan+%7C+Breakfast", notes: "", subItems: [] },
                    { id: 'd2a1', time: "09:30", title: "å‰å¾€å¤ªå®°åºœ", description: "æ­ä¹˜è¥¿éµé›»è»Šã€‚", type: "transport", mapQuery: "Nishitetsu Fukuoka (Tenjin) Station", image: "https://placehold.co/400x120/e8f0f7/3b82f6?text=Dazaifu+Train+%7C+Nishitetsu", notes: "å¯ç”¨ IC å¡ã€‚", subItems: [] },
                    { id: 'd2a2', time: "10:30", title: "å¤ªå®°åºœå¤©æ»¿å®®", description: "åƒæ‹œå­¸å•ä¹‹ç¥ã€‚", type: "sightseeing", mapQuery: "Dazaifu Tenmangu", image: "https://placehold.co/400x120/fef7f7/f43f5e?text=Dazaifu+Tenmangu+%7C+Shrine", notes: "è²·æ¢…æé¤…ã€‚", subItems: [{ id: 's1', text: 'æ‘¸å¾¡ç¥ç‰›', checked: false }] },
                    { id: 'd2a3', time: "14:30", title: "è³æ«»ï¼šèˆé¶´å…¬åœ’", description: "ç¦å²¡å¸‚å…§No.1è³æ«»åæ‰€ã€‚", type: "sightseeing", mapQuery: "Maizuru Park Fukuoka", image: "https://placehold.co/400x120/ffeef1/ec4899?text=Maizuru+Park+%7C+Sakura", notes: "", subItems: [] },
                    { id: 'd2a4', time: "18:30", title: "æ™šé¤ï¼šç‡’è‚‰ nikuya", description: "é«˜å“è³ªæ—¥å¼ç‡’è‚‰ã€‚", type: "food", mapQuery: "Yakiniku Nikuya Fukuoka", image: "https://placehold.co/400x120/f9f3e8/c75050?text=Yakiniku+Nikuya+%7C+Wagyu", notes: "å·²é ç´„ 18:30ã€‚", subItems: [] },
                    { id: 'd2a5', time: "20:30", title: "å¤©ç¥åœ°å€é€›è¡—", description: "äº«å—å¤œé–“è³¼ç‰©æ¨‚è¶£ã€‚", type: "shopping", mapQuery: "Tenjin Underground Shopping Center", image: "https://placehold.co/400x120/faf8f9/6e4c8e?text=Tenjin+Shopping+%7C+Tenjin", notes: "", subItems: [] }
                ]
            },
            {
                day: 3, date: "4/8 (ä¸‰)", title: "è²“å³¶ç™‚ç™’ & ç¶“å…¸æ‹‰éºµä¹‹å¤œ",
                activities: [
                    { id: 'd3a1', time: "08:00", title: "å‰å¾€æ–°å®®æ¸¯", description: "JRåšå¤šç«™ â†’ ç¦å·¥å¤§å‰ç«™ â†’ æ–°å®®æ¸¯ã€‚", type: "transport", mapQuery: "Shingu Port Ferry Terminal", image: "https://placehold.co/400x120/f0f8ff/3b82f6?text=Shingu+Port+%7C+Ferry", notes: "å·´å£«æ™‚åˆ»è¦æ³¨æ„ã€‚", subItems: [] },
                    { id: 'd3a2', time: "09:20", title: "æ­ä¹˜æ¸¡è¼ª (å»ç¨‹)", description: "èˆ¹ç¨‹ç´„17åˆ†é˜ã€‚", type: "ferry", mapQuery: "Shingu Port", image: "https://placehold.co/400x120/e6f9f9/06b6d4?text=Ferry+Departure+%7C+Depart", notes: "æº–å‚™é›¶éŒ¢ã€‚", subItems: [] },
                    { id: 'd3a3', time: "09:40", title: "ç›¸å³¶ (è²“å³¶) æ¢ç´¢", description: "èˆ‡è²“å’ªäº’å‹•ã€ç’°å³¶æ•£æ­¥ã€‚", type: "sightseeing", mapQuery: "Ainoshima Shingu", image: "https://placehold.co/400x120/f5fff5/22c55e?text=Ainoshima+%7C+Cat", notes: "ä¸è¦éš¨æ„é¤µé£Ÿã€‚", subItems: [] },
                    { id: 'd3a4', time: "13:50", title: "æ­ä¹˜æ¸¡è¼ª (å›ç¨‹)", description: "å»ºè­°æ­ä¹˜æ­¤ç­èˆ¹ç­è¿”å›ã€‚", type: "ferry", mapQuery: "Ainoshima Ferry Terminal", image: "https://placehold.co/400x120/e6f9f9/06b6d4?text=Ferry+Return+%7C+Return", notes: "", subItems: [] },
                    { id: 'd3a5', time: "16:00", title: "åšå¤šç«™å‘¨é‚Šé€›è¡—", description: "JRåšå¤šåŸã€åšå¤šé˜ªæ€¥ã€‚", type: "shopping", mapQuery: "JR Hakata City", image: "https://placehold.co/400x120/fcf8ff/8b5cf6?text=Hakata+Shopping+%7C+Shopping", notes: "", subItems: [] },
                    { id: 'd3a6', time: "19:30", title: "æ™šé¤ï¼šä¸€è˜­æ‹‰éºµ", description: "å¤©ç¥è¥¿é€šåº— (ç¸½æœ¬åº—)ã€‚", type: "food", mapQuery: "Ichiran Tenjin Nishidori", image: "https://placehold.co/400x120/fff7e6/d97706?text=Ichiran+Ramen+%7C+Main", notes: "é»ç¡¬éºµï¼", subItems: [] }
                ]
            },
            {
                day: 4, date: "4/9 (å››)", title: "å¤§æ¿ å…¬åœ’ & æ»¿è¼‰è€Œæ­¸",
                activities: [
                    { id: 'd4a1', time: "09:00", title: "å¤§æ¿ å…¬åœ’æ•£æ­¥", description: "ç¦å²¡å¸‚æ°‘çš„å¾ŒèŠ±åœ’ã€‚", type: "sightseeing", mapQuery: "Ohori Park", image: "https://placehold.co/400x120/f0f8ff/3b82f6?text=Ohori+Park+%7C+Park", notes: "", subItems: [] },
                    { id: 'd4a2', time: "11:00", title: "æœ€å¾Œæ¡è²·ï¼šåšå¤šç«™", description: "è³¼è²·ä¼´æ‰‹ç¦®ã€‚", type: "shopping", mapQuery: "Ming Hakata Station", image: "https://placehold.co/400x120/fcf8ff/8b5cf6?text=Hakata+Souvenir+%7C+Gifts", notes: "", subItems: [] },
                    { id: 'd4a3', time: "15:00", title: "å‰å¾€ç¦å²¡æ©Ÿå ´", description: "æ­ä¹˜åœ°éµç›´é”ã€‚", type: "transport", mapQuery: "Fukuoka Airport", image: "https://placehold.co/400x120/e8f0f7/3b82f6?text=To+FUK+Airport+%7C+Airport", notes: "", subItems: [] },
                    { id: 'd4a4', time: "18:00", title: "æ­æ©Ÿè¿”ç¨‹", description: "å†è¦‹ç¦å²¡ï¼", type: "plane", mapQuery: "Fukuoka Airport International Terminal", image: "https://placehold.co/400x120/f7f7f7/6b7280?text=Departure+%7C+Return", notes: "", subItems: [] }
                ]
            }
        ];
        let itinerary = [];
        
        // æ¸¡è¼ªæ™‚åˆ»è¡¨è³‡æ–™ (ä¸è®Š)
        const ferrySchedule = {
            toIsland: [
                { time: "07:50", recommend: false },
                { time: "09:20", recommend: true, note: "æ¨è–¦å»ç¨‹ï¼Œæ™‚é–“å……è£•" },
                { time: "11:30", recommend: false },
                { time: "14:30", recommend: false },
                { time: "17:40", recommend: false },
            ],
            fromIsland: [
                { time: "07:00", recommend: false },
                { time: "08:40", recommend: false },
                { time: "10:50", recommend: false },
                { time: "13:50", recommend: true, note: "æ¨è–¦å›ç¨‹ï¼Œä¸‹åˆå¯é€›è¡—" },
                { time: "16:00", recommend: false },
                { time: "17:30", recommend: false },
            ]
        };

        // ====================================================================
        // 2. STORAGE & UTILS (å„²å­˜å’Œå·¥å…·å‡½å¼)
        // ====================================================================

        const loadState = () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    itinerary = data.itinerary || initialItineraryData;
                    // ç¢ºä¿èˆŠè³‡æ–™ä¹Ÿæœ‰ subItems æ¬„ä½
                    itinerary.forEach(day => {
                        day.activities.forEach(act => {
                            if (!act.subItems) act.subItems = [];
                        });
                    });
                    
                    packingList = data.packingList || initialPackingList;
                    activeTab = data.activeTab || 'itinerary'; 
                    activeDay = data.activeDay || 1;
                    return;
                } catch (e) {
                    console.error("Error loading state from localStorage, resetting.", e);
                }
            }
            itinerary = initialItineraryData;
            packingList = initialPackingList.map(group => ({ 
                ...group, 
                items: group.items.map(item => ({ ...item, id: item.id || crypto.randomUUID() })) 
            })); 
        };

        const saveState = () => {
            const dataToStore = {
                itinerary: itinerary,
                packingList: packingList, 
                activeTab: activeTab,
                activeDay: activeDay
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToStore));
            } catch (e) {
                console.error("Storage failed (likely quota exceeded)", e);
                alert("å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯åœ–ç‰‡æª”æ¡ˆå¤ªå¤§ï¼Œè«‹å˜—è©¦ä¸Šå‚³è¼ƒå°çš„åœ–ç‰‡ã€‚");
            }
        };


        const getIconHtml = (name, size = 18, className = "") => {
            return `<i data-lucide="${name}" class="w-${size/4} h-${size/4} ${className}"></i>`;
        };

        const getTypeColor = (type) => {
            switch(type) {
                case 'transport': return 'bg-teal-100 text-teal-700 border-teal-200';
                case 'food': return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                case 'sightseeing':
                case 'activity':
                case 'night': return 'bg-rose-100 text-rose-700 border-rose-200';
                case 'shopping': return 'bg-purple-100 text-purple-700 border-purple-200';
                case 'hotel': return 'bg-pink-100 text-pink-700 border-pink-200';
                case 'plane': return 'bg-gray-100 text-gray-700 border-gray-200';
                case 'ferry': return 'bg-teal-100 text-teal-700 border-teal-200';
                default: return 'bg-gray-100 text-gray-700 border-gray-200';
            }
        };
        
        const getTypeLabel = (type) => {
            switch(type) {
                case 'food': return 'ç¾é£Ÿ';
                case 'transport': return 'äº¤é€š';
                case 'sightseeing': return 'æ™¯é»';
                case 'shopping': return 'è³¼ç‰©';
                case 'ferry': return 'æ¸¡è¼ª';
                case 'plane': return 'é£›æ©Ÿ';
                case 'hotel': return 'ä½å®¿';
                case 'activity': return 'æ´»å‹•';
                default: return 'ä¸€èˆ¬';
            }
        };

        const getMapLink = (query) => {
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        };

        // --- NOTES Formatting Function ---
        const formatNotes = (text) => {
            if (!text) return '';
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            const markdownLinkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
            safeText = safeText.replace(markdownLinkRegex, (match, name, url) => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline font-medium break-all" onclick="event.stopPropagation()">${name}</a>`;
            });
            const rawUrlRegex = /(?<!href="|">)(https?:\/\/[^\s<]+)/g;
            safeText = safeText.replace(rawUrlRegex, (url) => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline font-medium break-all" onclick="event.stopPropagation()">${url}</a>`;
            });
            return safeText.replace(/\n/g, '<br>');
        };

        // --- Packing List Helpers ---
        const findPackingItem = (id) => {
            for (const categoryGroup of packingList) {
                const item = categoryGroup.items.find(i => i.id === id);
                if (item) {
                    return { item, categoryGroup };
                }
            }
            return { item: null, categoryGroup: null };
        };

        // ====================================================================
        // 3. RENDER FUNCTIONS (æ¸²æŸ“å‡½å¼)
        // ====================================================================

        const renderNavigation = () => {
            const nav = document.getElementById('navigation');
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'calendar', color: 'rose' },
                { id: 'ferry', label: 'æ¸¡è¼ªè³‡è¨Š', icon: 'anchor', color: 'teal' },
                { id: 'packing', label: 'æ¸…å–®', icon: 'list-checks', color: 'gray' }
            ];

            nav.innerHTML = tabs.map(tab => `
                <button 
                    onclick="setActiveTab('${tab.id}')"
                    class="flex flex-col items-center justify-center w-full h-full transition-colors ${
                        activeTab === tab.id 
                        ? (tab.id === 'packing' ? 'text-gray-800' : `text-${tab.color}-600`)
                        : 'text-gray-400 hover:text-gray-600'
                    }"
                >
                    ${getIconHtml(tab.icon, 20, 'mb-1')}
                    <span class="text-xs font-medium">${tab.label}</span>
                </button>
            `).join('');

            lucide.createIcons();
        };

        const renderItinerary = () => {
            const currentDayData = itinerary.find(day => day.day === activeDay);
            if (!currentDayData) return;

            const dayTabs = itinerary.map(day => `
                <button
                    onclick="setActiveDay(${day.day})"
                    class="flex-1 py-4 px-2 text-sm font-medium transition-all border-b-2 whitespace-nowrap ${
                        activeDay === day.day
                        ? 'border-rose-500 text-rose-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                    }"
                >
                    <div class="text-xs uppercase tracking-wider mb-1">Day ${day.day}</div>
                    <div>${day.date.split(' ')[0]}</div>
                </button>
            `).join('');

            const activitiesHtml = currentDayData.activities.map(activity => {
                const colorClass = getTypeColor(activity.type);
                const iconName = activity.type === 'transport' ? 'train' : 
                                 activity.type === 'food' ? 'utensils' : 
                                 activity.type === 'sightseeing' ? 'camera' : 
                                 activity.type === 'shopping' ? 'shopping-bag' : 
                                 activity.type === 'hotel' ? 'moon' :
                                 activity.type === 'plane' ? 'plane' :
                                 activity.type === 'ferry' ? 'anchor' : 'info';
                
                const typeLabel = getTypeLabel(activity.type);

                // Render Sub-items List
                const subItemsHtml = (activity.subItems || []).map(sub => `
                    <div class="flex items-center mt-2 group/sub">
                        <input 
                            type="checkbox" 
                            id="sub-${sub.id}"
                            ${sub.checked ? 'checked' : ''}
                            onchange="toggleSubItem(${activeDay}, '${activity.id}', '${sub.id}')"
                            class="sub-item-checkbox h-4 w-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500 cursor-pointer"
                        >
                        <label for="sub-${sub.id}" class="ml-2 text-sm text-gray-600 flex-1 cursor-pointer select-none">
                            ${sub.text}
                        </label>
                        <button onclick="deleteSubItem(${activeDay}, '${activity.id}', '${sub.id}')" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover/sub:opacity-100 transition-opacity">
                            ${getIconHtml('x', 14)}
                        </button>
                    </div>
                `).join('');

                return `
                    <div class="relative pl-10 group" id="activity-${activity.id}">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 group-last:hidden"></div>
                        <div class="absolute left-0 top-4 w-8 h-8 rounded-full border-4 border-pink-50 shadow-md flex items-center justify-center z-10 ${colorClass.split(' ')[0]} ${colorClass.split(' ')[1]}">
                            ${getIconHtml(iconName, 18)}
                        </div>

                        <div class="bg-white rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-xl overflow-hidden mb-8">
                            <div class="h-32 w-full overflow-hidden relative group/image">
                                <img 
                                    src="${activity.image || 'https://placehold.co/400x120/f9f9f9/a3a3a3?text=Custom+Activity'}" 
                                    alt="${activity.title}" 
                                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                    onerror="this.onerror=null;this.src='https://placehold.co/400x120/f9f9f9/a3a3a3?text=Image+Load+Error';"
                                >
                                <!-- Edit Button Overlay -->
                                <button onclick="showEditActivityModal(${activeDay}, '${activity.id}')" class="absolute top-2 right-10 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-rose-600 z-20">
                                    ${getIconHtml('pencil', 16)}
                                </button>
                                <!-- Delete Button Overlay -->
                                <button onclick="deleteActivity(${activeDay}, '${activity.id}', '${activity.title}')" class="absolute top-2 right-2 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-red-600 z-20">
                                    ${getIconHtml('x', 16)}
                                </button>
                            </div>

                            <div class="p-4 relative">
                                <div class="flex justify-between items-start mb-2 pt-1">
                                    <div class="flex items-center text-gray-500 text-sm font-semibold">
                                        ${getIconHtml('clock', 14, 'mr-1')}
                                        ${activity.time}
                                    </div>
                                    <span class="text-xs px-3 py-1 rounded-full font-medium border ${colorClass}">
                                        ${typeLabel}
                                    </span>
                                </div>
                                
                                <h3 class="text-lg font-bold text-gray-800 mb-2 group-hover:text-rose-600 transition-colors">
                                    ${activity.title}
                                </h3>
                                
                                <p class="text-gray-600 text-sm mb-4 leading-relaxed">
                                    ${activity.description}
                                </p>

                                <!-- Sub Items Section -->
                                <div class="mt-4 pt-3 border-t border-gray-100">
                                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">è¡Œç¨‹ç´°é …</h4>
                                    <div class="space-y-1 mb-3">
                                        ${subItemsHtml}
                                    </div>
                                    <!-- Add Sub Item Input -->
                                    <div class="flex items-center gap-2 mt-2">
                                        <input 
                                            type="text" 
                                            id="new-sub-${activity.id}"
                                            placeholder="æ–°å¢ç´°é …..." 
                                            class="flex-1 text-sm border-b border-gray-200 focus:border-rose-400 focus:outline-none py-1 px-1 bg-transparent"
                                            onkeypress="if(event.key === 'Enter') addSubItem(${activeDay}, '${activity.id}')"
                                        >
                                        <button onclick="addSubItem(${activeDay}, '${activity.id}')" class="text-rose-500 hover:text-rose-700">
                                            ${getIconHtml('plus-circle', 16)}
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-4 pt-3 border-t border-gray-100 bg-gray-50/50 -mx-4 -mb-4 p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-sm font-semibold text-gray-600 flex items-center">
                                            ${getIconHtml('notebook-text', 14, 'mr-1 text-gray-500')}
                                            å‚™è¨»:
                                        </h4>
                                        <button 
                                            onclick="showEditNotesModal(${activeDay}, '${activity.id}')"
                                            class="text-xs text-rose-500 hover:text-rose-700 flex items-center transition-colors font-medium"
                                        >
                                            ${getIconHtml('edit-2', 12, 'mr-1')} 
                                            ç·¨è¼¯
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-700 p-2 rounded-lg bg-white border border-gray-200">
                                        ${activity.notes ? formatNotes(activity.notes) : '<span class="text-gray-400 italic">é»æ“Šã€Œç·¨è¼¯ã€åŠ å…¥ç¶²å€é€£çµæˆ–æé†’...</span>'}
                                    </p>
                                    
                                    <a 
                                        href="${getMapLink(activity.mapQuery)}"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="mt-3 flex items-center justify-center w-full py-2 bg-white hover:bg-rose-50 text-gray-600 hover:text-rose-600 rounded-lg text-sm font-medium transition-colors border border-gray-200 hover:border-rose-300 shadow-sm"
                                    >
                                        ${getIconHtml('map', 16, 'mr-2')}
                                        æŸ¥çœ‹åœ°åœ–
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="flex bg-white shadow-sm shrink-0 overflow-x-auto no-scrollbar sticky top-0 z-10 border-b border-gray-200">
                    ${dayTabs}
                </div>
                <div class="p-4 pb-20 animate-fade-in">
                    <div class="mb-6 pt-2">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">${currentDayData.title}</h2>
                        <div class="h-1 w-10 bg-rose-500 rounded-full"></div>
                    </div>
                    <div class="space-y-0 relative">
                        ${activitiesHtml}
                    </div>
                    <div class="mt-8 text-center">
                        <button 
                            onclick="showAddActivityModal(${activeDay})" 
                            class="flex items-center justify-center px-6 py-3 bg-rose-600 text-white rounded-full font-semibold shadow-lg shadow-rose-200 hover:bg-rose-700 transition-all transform hover:scale-[1.02] active:scale-[0.98] text-sm"
                        >
                            ${getIconHtml('plus-circle', 18, 'mr-2')}
                            + æ–°å¢æ´»å‹• (Day ${activeDay})
                        </button>
                    </div>
                    <div class="mt-8 text-center text-gray-400 text-xs pb-4">
                        ğŸŒ¸ æ„Ÿè¬æ‚¨çš„ä½¿ç”¨ï¼Œç¥æ‚¨æ—…é€”æ„‰å¿« ğŸŒ¸
                    </div>
                </div>
            `;
        };

        const renderFerry = () => {
            const renderFerryTimes = (times) => times.map((item, idx) => `
                <div key="${idx}" class="flex items-center justify-between p-4 rounded-xl border transition-all ${item.recommend ?
                    'bg-teal-50 border-teal-300 shadow-md' : 'bg-white border-gray-200 hover:bg-gray-50'
                } mb-3">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full ${item.recommend ? 'bg-teal-500' : 'bg-gray-300'} mr-3"></div>
                        <span class="text-xl font-bold ${item.recommend ? 'text-teal-700' : 'text-gray-700'}">${item.time}</span>
                    </div>
                    ${item.recommend ? 
                        `<span class="text-sm font-medium text-teal-600 bg-teal-200 px-3 py-1 rounded-full">${item.note}</span>` : 
                        '<span class="text-sm text-gray-400">ä¸€èˆ¬ç­æ¬¡</span>'
                    }
                </div>
            `).join('');

            return `
                <div class="p-4 animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        ${getIconHtml('anchor', 24, 'mr-2 text-teal-600')}
                        ç›¸å³¶æ¸¡è¼ªæ™‚åˆ»è¡¨
                    </h2>
                    <p class="text-gray-600 mb-6 border-l-4 border-teal-300 pl-3">
                        åœ°é»ï¼šæ–°å®®æ¸¯ â†” ç›¸å³¶ã€‚å–®ç¨‹ç´„ 17 åˆ†é˜ã€‚<br>
                        <span class="font-semibold text-sm text-red-500">
                           æ³¨æ„ï¼šèˆ¹ç¥¨éœ€åœ¨çª—å£è³¼è²·ï¼Œåªæ”¶ç¾é‡‘ï¼è«‹æå‰åˆ°é”ã€‚
                        </span>
                    </p>
                    <div class="mb-8 p-4 bg-teal-50 rounded-xl shadow-inner border border-teal-200">
                        <h3 class="text-lg font-bold text-teal-700 mb-3 flex items-center">
                            ${getIconHtml('arrow-right-circle', 18, 'mr-2')}
                            å»ç¨‹ï¼šæ–°å®®æ¸¯ â†’ ç›¸å³¶
                        </h3>
                        ${renderFerryTimes(ferrySchedule.toIsland)}
                    </div>
                    <div class="mb-8 p-4 bg-teal-50 rounded-xl shadow-inner border border-teal-200">
                        <h3 class="text-lg font-bold text-teal-700 mb-3 flex items-center">
                            ${getIconHtml('arrow-left-circle', 18, 'mr-2')}
                            å›ç¨‹ï¼šç›¸å³¶ â†’ æ–°å®®æ¸¯
                        </h3>
                        ${renderFerryTimes(ferrySchedule.fromIsland)}
                    </div>
                    <div class="text-center text-gray-400 text-xs pb-4">
                        è³‡æ–™ä¾†æºï¼šæ–°å®®ç”ºå…¬æ‰€ç¶²ç«™ (è«‹ä»¥ç¾å ´å…¬å‘Šç‚ºæº–)
                    </div>
                </div>
            `;
        };

        const renderPacking = () => {
            const renderListItems = (items) => items.map(item => `
                <div key="${item.id}" class="flex items-center bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 transition-all hover:shadow-md">
                    <input 
                        type="checkbox" 
                        id="item-${item.id}" 
                        ${item.checked ? 'checked' : ''} 
                        onchange="togglePackingItem('${item.id}')"
                        class="form-checkbox h-5 w-5 text-gray-600 border-gray-300 rounded-md transition duration-150 ease-in-out cursor-pointer checked:bg-gray-600 checked:border-gray-600 focus:ring-gray-500 mr-4"
                    >
                    <label 
                        for="item-${item.id}" 
                        class="flex-1 text-gray-800 text-base cursor-pointer ${item.checked ? 'line-through text-gray-400 italic' : 'font-medium'}"
                    >
                        ${item.text}
                    </label>
                    <button onclick="deletePackingItem('${item.id}', '${item.text}')" class="text-gray-300 hover:text-red-500 ml-3 transition-colors p-1 rounded-full hover:bg-red-50">
                        ${getIconHtml('trash-2', 16)}
                    </button>
                </div>
            `).join('');

            const categorizedListHtml = packingList.map(categoryGroup => `
                <div class="mb-8 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-gray-500 pl-3 flex items-center">
                        ${getIconHtml('package', 18, 'mr-2 text-gray-600')}
                        ${categoryGroup.category}
                    </h3>
                    <div class="space-y-3">
                        ${renderListItems(categoryGroup.items)}
                    </div>
                </div>
            `).join('');

            const categoryOptions = packingList.map(group => 
                `<option value="${group.category}">${group.category}</option>`
            ).join('');

            return `
                <div class="p-4 pb-20 animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        ${getIconHtml('list-checks', 24, 'mr-2 text-gray-700')}
                        æ—…è¡Œæ‰“åŒ…æ¸…å–®
                    </h2>
                    <p class="text-gray-600 mb-6 border-l-4 border-gray-300 pl-3">
                        å‡ºç™¼å‰å‹¾é¸ï¼Œç¢ºä¿è¬ç„¡ä¸€å¤±ï¼æ¸…å–®å·²æŒ‰å¤§é …ç›®åˆ†é¡ã€‚
                    </p>
                    <div id="packing-list-items" class="mb-8 space-y-4">
                        ${categorizedListHtml}
                    </div>
                    <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                            ${getIconHtml('plus-square', 18, 'mr-2')}
                            æ–°å¢é …ç›®
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label for="newPackingItemCategory" class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åˆ†é¡</label>
                                <select id="newPackingItemCategory" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-gray-500 focus:border-gray-500 bg-white">
                                    ${categoryOptions}
                                </select>
                            </div>
                            <div>
                                <label for="newPackingItemText" class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="newPackingItemText" placeholder="è¼¸å…¥è¦æ–°å¢çš„ç‰©å“åç¨±..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-gray-500 focus:border-gray-500 transition duration-150" onkeypress="if(event.key === 'Enter') addPackingItem()">
                                    <button onclick="addPackingItem()" class="px-4 py-3 bg-gray-600 text-white rounded-lg font-semibold shadow-md hover:bg-gray-700 transition-colors active:scale-95">åŠ å…¥</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 text-center text-gray-400 text-xs pb-4">
                        ğŸ’¡ æ‰“åŒ…è¶Šå°‘ï¼Œæ—…é€”è¶Šè¼•é¬† ğŸ’¡
                    </div>
                </div>
            `;
        };

        const renderContent = () => {
            const contentDiv = document.getElementById('main-content');
            let contentHtml = '';
            switch (activeTab) {
                case 'itinerary': contentHtml = renderItinerary(); break;
                case 'ferry': contentHtml = renderFerry(); break;
                case 'packing': contentHtml = renderPacking(); break;
                default: contentHtml = `<div class="p-4 text-center text-red-500">éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ­¤é é¢ã€‚</div>`;
            }
            contentDiv.innerHTML = contentHtml;
            lucide.createIcons();
        };

        const initializeApp = () => {
            loadState();
            renderNavigation();
            renderContent();
        };

        // ====================================================================
        // 4. INTERACTION FUNCTIONS (äº’å‹•å‡½å¼)
        // ====================================================================

        const setActiveTab = (tabId) => {
            activeTab = tabId;
            saveState();
            renderNavigation();
            renderContent();
        };

        const setActiveDay = (day) => {
            activeDay = day;
            saveState();
            renderContent();
        };

        const togglePackingItem = (id) => {
            const { item } = findPackingItem(id);
            if (item) {
                item.checked = !item.checked;
                saveState();
                renderContent();
            }
        };

        const addPackingItem = () => {
            const input = document.getElementById('newPackingItemText');
            const select = document.getElementById('newPackingItemCategory');
            const text = input.value.trim();
            const categoryName = select.value;
            if (!text) { console.error("è«‹è¼¸å…¥é …ç›®åç¨±ï¼"); return; }
            const newItem = { id: crypto.randomUUID(), text: text, checked: false };
            let categoryGroup = packingList.find(g => g.category === categoryName);
            if (categoryGroup) { categoryGroup.items.push(newItem); } 
            else { packingList[0].items.push(newItem); }
            input.value = '';
            saveState();
            renderContent();
        };

        const deletePackingItem = (id, name) => {
            showCustomModal({
                title: 'ç¢ºèªåˆªé™¤',
                body: `ç¢ºå®šè¦å¾æ¸…å–®ä¸­ç§»é™¤ã€Œ${name}ã€å—ï¼Ÿ`,
                confirmText: 'ç§»é™¤',
                cancelText: 'å–æ¶ˆ',
                onConfirm: () => {
                    const { categoryGroup } = findPackingItem(id);
                    if (categoryGroup) {
                        categoryGroup.items = categoryGroup.items.filter(item => item.id !== id);
                        saveState();
                        renderContent();
                    }
                    closeModal();
                }
            });
        };

        // --- Sub-Item Interactions ---
        const addSubItem = (dayNum, activityId) => {
            const input = document.getElementById(`new-sub-${activityId}`);
            const text = input.value.trim();
            if (!text) return;

            const activity = findActivity(dayNum, activityId);
            if (activity) {
                if (!activity.subItems) activity.subItems = [];
                activity.subItems.push({ id: crypto.randomUUID(), text, checked: false });
                saveState();
                renderContent();
            }
        };

        const toggleSubItem = (dayNum, activityId, subItemId) => {
            const activity = findActivity(dayNum, activityId);
            if (activity && activity.subItems) {
                const sub = activity.subItems.find(s => s.id === subItemId);
                if (sub) {
                    sub.checked = !sub.checked;
                    saveState();
                    renderContent();
                }
            }
        };

        const deleteSubItem = (dayNum, activityId, subItemId) => {
            const activity = findActivity(dayNum, activityId);
            if (activity && activity.subItems) {
                activity.subItems = activity.subItems.filter(s => s.id !== subItemId);
                saveState();
                renderContent();
            }
        };

        const findActivity = (dayNum, activityId) => {
            const day = itinerary.find(d => d.day === dayNum);
            if (day) { return day.activities.find(a => a.id === activityId); }
            return null;
        };

        const updateActivityNotes = (dayNum, activityId, newNotes) => {
            const activity = findActivity(dayNum, activityId);
            if (activity) {
                activity.notes = newNotes;
                saveState();
                renderContent();
            }
        };

        const updateActivityImage = (dayNum, activityId, newImageBase64) => {
            const activity = findActivity(dayNum, activityId);
            if (activity) {
                activity.image = newImageBase64;
                saveState();
                renderContent();
            }
        };

        const updateActivity = (dayNum, updatedActivity) => {
            const day = itinerary.find(d => d.day === dayNum);
            if (day) {
                const index = day.activities.findIndex(a => a.id === updatedActivity.id);
                if (index !== -1) {
                    day.activities[index] = updatedActivity;
                    // Sort again if time changed
                    day.activities.sort((a, b) => a.time.localeCompare(b.time));
                    saveState();
                    renderContent();
                }
            }
        };

        const deleteActivity = (dayNum, activityId, title) => {
            showCustomModal({
                title: 'ç¢ºèªåˆªé™¤è¡Œç¨‹',
                body: `ç¢ºå®šè¦å¾ Day ${dayNum} ç§»é™¤æ´»å‹•ã€Œ${title}ã€å—ï¼Ÿ`,
                confirmText: 'ç§»é™¤',
                cancelText: 'å–æ¶ˆ',
                onConfirm: () => {
                    const day = itinerary.find(d => d.day === dayNum);
                    if (day) {
                        day.activities = day.activities.filter(a => a.id !== activityId);
                        saveState();
                        renderContent();
                    }
                    closeModal();
                }
            });
        };

        const addActivity = (dayNum, newActivity) => {
            const day = itinerary.find(d => d.day === dayNum);
            if (day) {
                day.activities.push({
                    id: crypto.randomUUID(),
                    ...newActivity,
                    time: newActivity.time || 'å¾…å®š',
                    description: newActivity.description || 'ç„¡æè¿°',
                    mapQuery: newActivity.mapQuery || newActivity.title,
                    image: newActivity.image || 'https://placehold.co/400x120/f9f9f9/a3a3a3?text=New+Activity',
                    notes: newActivity.notes || '',
                    subItems: []
                });
                day.activities.sort((a, b) => a.time.localeCompare(b.time));
                saveState();
                renderContent();
            }
        };

        // ====================================================================
        // 5. MODAL FUNCTIONS (å½ˆå‡ºè¦–çª—å‡½å¼)
        // ====================================================================
        
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');

        const closeModal = (event) => {
            if (event && event.target !== modalBackdrop) return;
            modalBackdrop.classList.remove('open');
            tempImageBase64 = ''; // Clear temp image
            setTimeout(() => { modalContent.innerHTML = ''; }, 300); 
        };

        const openModal = (htmlContent) => {
            modalContent.innerHTML = htmlContent;
            lucide.createIcons();
            modalBackdrop.classList.add('open');
        };

        const showCustomModal = ({ title, body, confirmText, cancelText, onConfirm }) => {
            const html = `
                <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                <p class="text-gray-700 mb-6">${body}</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium">${cancelText}</button>
                    <button onclick="onConfirm()" class="px-4 py-2 text-white bg-rose-600 rounded-lg hover:bg-rose-700 transition-colors font-medium shadow-md">${confirmText}</button>
                </div>
            `;
            openModal(html);
        };

        // --- Image Handling ---
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImageBase64 = e.target.result;
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.src = tempImageBase64;
                        preview.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- Note Links ---
        window.toggleLinkInput = () => {
            const linkSection = document.getElementById('link-input-section');
            if (linkSection) {
                linkSection.classList.toggle('hidden');
            }
        };

        window.confirmInsertLink = () => {
            const nameInput = document.getElementById('link-name-input');
            const urlInput = document.getElementById('link-url-input');
            const name = nameInput.value.trim();
            const url = urlInput.value.trim();

            if (!name || !url) {
                alert("è«‹è¼¸å…¥é¡¯ç¤ºåç¨±èˆ‡ç¶²å€ï¼");
                return;
            }

            const markdownLink = `[${name}](${url})`;
            const textarea = document.getElementById('note-textarea');
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, startPos) + markdownLink + text.substring(endPos, text.length);
            
            nameInput.value = '';
            urlInput.value = '';
            document.getElementById('link-input-section').classList.add('hidden');
            textarea.focus();
        };

        const showEditNotesModal = (dayNum, activityId) => {
            const activity = findActivity(dayNum, activityId);
            if (!activity) return;
            const modalHtml = `
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        ${getIconHtml('notebook-text', 20, 'mr-2 text-rose-500')}
                        ç·¨è¼¯å‚™è¨»
                    </h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        ${getIconHtml('x', 20)}
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-3 font-medium">æ´»å‹•ï¼š${activity.title}</p>
                <div class="mb-2 flex justify-end">
                    <button type="button" onclick="toggleLinkInput()" class="text-sm text-rose-600 hover:text-rose-700 font-medium flex items-center bg-rose-50 px-3 py-1.5 rounded-full transition-colors">
                        ${getIconHtml('link', 14, 'mr-1')} åŠ å…¥è¶…é€£çµ
                    </button>
                </div>
                <div id="link-input-section" class="hidden mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200 animate-fade-in">
                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <input type="text" id="link-name-input" placeholder="é¡¯ç¤ºåç¨±" class="w-full text-sm p-2 border border-gray-300 rounded focus:border-rose-400 focus:outline-none">
                        <input type="text" id="link-url-input" placeholder="ç¶²å€ (https://...)" class="w-full text-sm p-2 border border-gray-300 rounded focus:border-rose-400 focus:outline-none">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="toggleLinkInput()" class="text-gray-500 text-xs hover:underline">å–æ¶ˆ</button>
                        <button type="button" onclick="confirmInsertLink()" class="bg-rose-500 text-white text-xs px-3 py-1.5 rounded hover:bg-rose-600">æ’å…¥</button>
                    </div>
                </div>
                <textarea id="note-textarea" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500 transition duration-150 resize-none text-sm" placeholder="è¼¸å…¥å‚™è¨»...">${activity.notes}</textarea>
                <div class="flex justify-end space-x-3 mt-4 pt-2">
                    <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveNotes(${dayNum}, '${activityId}')" class="px-4 py-2 text-sm text-white bg-rose-600 rounded-lg hover:bg-rose-700 transition-colors shadow-md">å„²å­˜</button>
                </div>
            `;
            openModal(modalHtml);
        };

        const saveNotes = (dayNum, activityId) => {
            const textarea = document.getElementById('note-textarea');
            const newNotes = textarea.value.trim();
            updateActivityNotes(dayNum, activityId, newNotes);
            closeModal();
        };

        const showAddActivityModal = (dayNum) => {
            // Clear temp image
            tempImageBase64 = '';
            
            const activityTypes = [
                { value: 'sightseeing', label: 'æ™¯é»', icon: 'camera' },
                { value: 'food', label: 'ç¾é£Ÿ', icon: 'utensils' },
                { value: 'shopping', label: 'è³¼ç‰©', icon: 'shopping-bag' },
                { value: 'transport', label: 'äº¤é€š', icon: 'train' },
                { value: 'activity', label: 'å…¶ä»–æ´»å‹•', icon: 'info' }
            ];
            const typeOptions = activityTypes.map(type => `<option value="${type.value}" data-icon="${type.icon}">${type.label}</option>`).join('');
            const modalHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">æ–°å¢æ´»å‹• (Day ${dayNum})</h3>
                <div class="space-y-4">
                    <div>
                        <label for="newTitle" class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åç¨± *</label>
                        <input type="text" id="newTitle" placeholder="å¦‚ï¼šä¸€è˜­æ‹‰éºµ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                    </div>
                    <div>
                        <label for="newTime" class="block text-sm font-medium text-gray-700 mb-1">é è¨ˆæ™‚é–“</label>
                        <input type="time" id="newTime" value="12:00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                    </div>
                    <div>
                        <label for="newType" class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•é¡å‹</label>
                        <select id="newType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500 bg-white">${typeOptions}</select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åœ–ç‰‡</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                            <label for="imageInput" class="cursor-pointer flex flex-col items-center">
                                ${getIconHtml('upload-cloud', 24, 'text-gray-400 mb-2')}
                                <span class="text-sm text-gray-500">é»æ“Šä¸Šå‚³åœ–ç‰‡</span>
                            </label>
                            <img id="imagePreview" src="" class="hidden mt-3 max-h-32 rounded mx-auto object-cover border border-gray-200">
                        </div>
                    </div>
                    <div>
                        <label for="newDescription" class="block text-sm font-medium text-gray-700 mb-1">è©³ç´°æè¿°</label>
                        <textarea id="newDescription" rows="2" placeholder="ç°¡çŸ­æè¿°æ´»å‹•å…§å®¹" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500 resize-none"></textarea>
                    </div>
                    <div>
                        <label for="newMapQuery" class="block text-sm font-medium text-gray-700 mb-1">åœ°åœ–æœå°‹é—œéµå­—</label>
                        <input type="text" id="newMapQuery" placeholder="å¦‚ï¼šIchiran Tenjin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium">å–æ¶ˆ</button>
                    <button onclick="saveNewActivity(${dayNum})" class="px-4 py-2 text-white bg-rose-600 rounded-lg hover:bg-rose-700 transition-colors font-medium shadow-md">æ–°å¢æ´»å‹•</button>
                </div>
            `;
            openModal(modalHtml);
        };

        const saveNewActivity = (dayNum) => {
            const title = document.getElementById('newTitle').value.trim();
            const time = document.getElementById('newTime').value.trim();
            const type = document.getElementById('newType').value;
            const description = document.getElementById('newDescription').value.trim();
            const mapQuery = document.getElementById('newMapQuery').value.trim() || title;
            if (!title) { console.error("æ´»å‹•åç¨±æ˜¯å¿…å¡«çš„ï¼"); return; }
            const newActivity = { 
                title, time, type, description, mapQuery, 
                image: tempImageBase64 || '', // Save uploaded image
                notes: '', subItems: [] 
            };
            addActivity(dayNum, newActivity);
            closeModal();
        };

        // --- NEW: Edit Activity Modal ---
        window.showEditActivityModal = (dayNum, activityId) => {
            const activity = findActivity(dayNum, activityId);
            if (!activity) return;
            tempImageBase64 = activity.image || ''; // Initialize with existing image

            const activityTypes = [
                { value: 'sightseeing', label: 'æ™¯é»' },
                { value: 'food', label: 'ç¾é£Ÿ' },
                { value: 'shopping', label: 'è³¼ç‰©' },
                { value: 'transport', label: 'äº¤é€š' },
                { value: 'activity', label: 'å…¶ä»–æ´»å‹•' }
            ];
            const typeOptions = activityTypes.map(type => `<option value="${type.value}" ${activity.type === type.value ? 'selected' : ''}>${type.label}</option>`).join('');

            const modalHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">ç·¨è¼¯æ´»å‹•</h3>
                <div class="space-y-4">
                    <div>
                        <label for="editTitle" class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•åç¨± *</label>
                        <input type="text" id="editTitle" value="${activity.title}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editTime" class="block text-sm font-medium text-gray-700 mb-1">é è¨ˆæ™‚é–“</label>
                            <input type="time" id="editTime" value="${activity.time}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                        </div>
                        <div>
                            <label for="editType" class="block text-sm font-medium text-gray-700 mb-1">æ´»å‹•é¡å‹</label>
                            <select id="editType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500 bg-white">${typeOptions}</select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ›´æ›åœ–ç‰‡</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                            <input type="file" id="editImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                            <label for="editImageInput" class="cursor-pointer flex flex-col items-center">
                                ${getIconHtml('image', 24, 'text-gray-400 mb-2')}
                                <span class="text-sm text-gray-500">é»æ“Šä¸Šå‚³æ–°åœ–ç‰‡</span>
                            </label>
                            <img id="imagePreview" src="${activity.image}" class="${activity.image ? '' : 'hidden'} mt-3 max-h-40 rounded mx-auto object-cover border border-gray-200">
                        </div>
                    </div>

                    <div>
                        <label for="editDescription" class="block text-sm font-medium text-gray-700 mb-1">è©³ç´°æè¿°</label>
                        <textarea id="editDescription" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500 resize-none">${activity.description}</textarea>
                    </div>
                    <div>
                        <label for="editMapQuery" class="block text-sm font-medium text-gray-700 mb-1">åœ°åœ–æœå°‹é—œéµå­—</label>
                        <input type="text" id="editMapQuery" value="${activity.mapQuery}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors font-medium">å–æ¶ˆ</button>
                    <button onclick="saveEditedActivity(${dayNum}, '${activityId}')" class="px-4 py-2 text-white bg-rose-600 rounded-lg hover:bg-rose-700 transition-colors font-medium shadow-md">å„²å­˜è®Šæ›´</button>
                </div>
            `;
            openModal(modalHtml);
        };

        window.saveEditedActivity = (dayNum, activityId) => {
            const activity = findActivity(dayNum, activityId);
            if (!activity) return;

            activity.title = document.getElementById('editTitle').value.trim();
            activity.time = document.getElementById('editTime').value.trim();
            activity.type = document.getElementById('editType').value;
            activity.description = document.getElementById('editDescription').value.trim();
            activity.mapQuery = document.getElementById('editMapQuery').value.trim() || activity.title;
            
            // Only update image if a new one was uploaded (tempImageBase64 is not empty)
            // If user didn't upload new, keep old.
            // But wait, showEditActivityModal initialized tempImageBase64 with old image.
            // So we can just assign tempImageBase64.
            activity.image = tempImageBase64;

            updateActivity(dayNum, activity);
            closeModal();
        };

        // ====================================================================
        // 6. INITIALIZATION (åˆå§‹åŒ–)
        // ====================================================================

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>