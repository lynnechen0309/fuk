<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡æ—…éŠå°å¹«æ‰‹ - å¼·åŒ–ç·¨è¼¯èˆ‡ AI ç‰ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN for visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar styles */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Define fade-in animation */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 480px; /* Increased modal width for more fields */
            max-height: 90vh; 
            overflow-y: auto; 
            transform: translateY(-30px);
            transition: transform 0.3s ease;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); 
        }
        .modal-backdrop.open .modal-content {
            transform: translateY(0);
        }
        /* Sub-item specific styles */
        .sub-item-checkbox:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }
        /* Sync Indicator */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #10b981; /* Green */
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 60;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        .sync-status.saving {
            color: #f59e0b; /* Amber */
        }
        /* Style for LLM Generated Content */
        .llm-suggestion-card {
            border: 1px solid #e5e5e5;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f0f9ff; /* Blue background for AI */
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .llm-suggestion-card h4 {
            font-weight: 700;
            color: #0c4a6e;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }
        .llm-suggestion-card p {
            font-size: 0.875rem;
            color: #1e293b;
            line-height: 1.5;
        }
    </style>
</head>
<body class="bg-pink-50 antialiased h-screen flex flex-col">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="max-w-md mx-auto bg-white h-full flex flex-col font-sans text-gray-800 shadow-2xl overflow-hidden relative">
        
        <!-- Header -->
        <div id="header" class="bg-gradient-to-br from-rose-400 to-pink-300 p-6 text-white shrink-0 shadow-lg z-20">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">ç¦å²¡æ«»èŠ±ç´€è¡Œ (AI åŠ©æ‰‹)</h1>
                    <p class="text-pink-100 text-sm mt-1">é›²ç«¯åŒæ­¥ç‰ˆ â€¢ 4å¤©3å¤œ</p>
                    <div class="text-xs text-pink-100/70 flex items-center gap-1 mt-3">
                        <i data-lucide="key-round" class="w-3 h-3"></i>
                        <span id="user-id-display">ç”¨æˆ¶ ID è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                <div class="p-2 rounded-xl border border-white/40 backdrop-blur-sm">
                    <i data-lucide="sparkles" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="scroll-container z-10 bg-pink-50">
            <!-- Content will be rendered here by JavaScript -->
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-500 mx-auto mb-2"></div>
                    <p>æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="navigation" class="bg-white border-t border-gray-100 shrink-0 w-full flex justify-around items-center h-16 z-30 shadow-t-lg">
            <!-- Navigation buttons will be rendered here by JavaScript -->
        </div>
        
        <!-- Sync Status Indicator -->
        <div id="syncStatus" class="sync-status hidden">
            <i data-lucide="cloud-check" class="w-4 h-4"></i>
            <span>å·²åŒæ­¥</span>
        </div>

        <!-- Modal Structure -->
        <div id="modal-backdrop" class="modal-backdrop" onclick="closeModal(event)">
            <div id="modal-content" class="modal-content" onclick="event.stopPropagation()">
                <!-- Modal content will be injected here -->
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // 1. CONSTANTS AND CONFIGURATION (è¨­å®š)
        // ====================================================================
        
        // âš ï¸ éƒ¨ç½²æ™‚ï¼Œè«‹å°‡ä¸‹æ–¹çš„ apiKey ç•™ç©ºï¼ŒCanvas æœƒè‡ªå‹•æ³¨å…¥
        const GEMINI_API_KEY = "";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // Firebase Config (ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„å®¢è£½åŒ–è¨­å®š)
        const customFirebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };
        
        // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨ customFirebaseConfig
        const envConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : {};
        const firebaseConfig = Object.keys(envConfig).length > 0 ? envConfig : customFirebaseConfig;
        
        // ä½¿ç”¨ç’°å¢ƒæä¾›çš„ App IDï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨ Firebase Project ID ä½œç‚ºé è¨­ App ID
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Data Path: /artifacts/{appId}/public/data/fukuoka_trip/shared_plan
        const tripDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'fukuoka_trip', 'shared_plan');

        // ====================================================================
        // 2. STATE MANAGEMENT (ç‹€æ…‹ç®¡ç†)
        // ====================================================================

        let activeTab = localStorage.getItem('local_activeTab') || 'itinerary';
        let activeDay = parseInt(localStorage.getItem('local_activeDay') || '1');
        let itinerary = []; 
        let packingList = [];
        let isDataLoaded = false;
        let userId = null;
        
        // LLM ç›¸é—œç‹€æ…‹ (ç”¨æ–¼å„²å­˜æ‘˜è¦çµæœï¼Œä¸å­˜å…¥ Firebase)
        let llmCache = {
            daySummaries: {}, // { dayNum: { text: "...", sources: [{ uri, title }] } }
            loadingActivity: null, // Stores actId being loaded for sub-suggestions
            loadingDay: null // Stores dayNum being loaded for daily summary
        };

        // é è¨­è³‡æ–™ (ä¸è®Š)
        const initialPackingList = [
            { category: 'æ–‡ä»¶èˆ‡é‡‘éŒ¢', items: [{ id: 'p1', text: 'è­·ç…§', checked: false }, { id: 'p2', text: 'æ—¥å¹£ç¾é‡‘', checked: false }] },
            { category: 'é›»å­ç”¢å“', items: [{ id: 'p4', text: 'ç¶²å¡/SIMå¡', checked: false }, { id: 'p5', text: 'è¡Œå‹•é›»æº', checked: false }] },
            { category: 'è¡£ç‰©èˆ‡ç”¨å“', items: [{ id: 'p7', text: 'å¥½èµ°çš„é‹', checked: false }, { id: 'p8', text: 'é›¨å…·', checked: false }] },
            { category: 'è—¥å“', items: [{ id: 'p10', text: 'å¸¸å‚™è—¥', checked: false }] }
        ];

        const initialItineraryData = [
            { day: 1, date: "4/6 (ä¸€)", title: "æŠµé”ç¦å²¡ - FUK", activities: [
                { id: 'act1', time: "14:00", title: "æŠµé”ç¦å²¡æ©Ÿå ´", type: "plane", description: "é ˜å–è¡ŒæåŠç¶²å¡ï¼Œæ­ä¹˜åœ°éµå‰å¾€é£¯åº—ã€‚", mapQuery: "ç¦å²¡æ©Ÿå ´åœ‹éš›ç·š", subItems: [{ id: 's1', text: 'è³¼è²·åœ°éµä¸€æ—¥åˆ¸', checked: false }], image: '', notes: 'æ©Ÿå ´å…Œæ›ç¥¨åˆ¸\nhttps://www.google.com' },
                { id: 'act2', time: "16:00", title: "ä¸­æ´²å·ç«¯å•†åº—è¡—", type: "sightseeing", description: "åˆ°é£¯åº— Check-in å¾Œï¼Œå‰å¾€ä¸­æ´²å·ç«¯å•†åº—è¡—é€›é€›ã€‚", mapQuery: "ä¸­æ´²å·ç«¯å•†åº—è¡—", subItems: [], image: 'https://placehold.co/400x120/f9f9f9/a3a3a3?text=å•†åº—è¡—', notes: '' }
            ]},
            { day: 2, date: "4/7 (äºŒ)", title: "å¤ªå®°åºœ & è³æ«»", activities: [
                { id: 'act3', time: "09:00", title: "å¤ªå®°åºœå¤©æ»¿å®®", type: "sightseeing", description: "åƒæ‹œå­¸å•ä¹‹ç¥ï¼Œé †é“åƒæ¢…æé¤…ã€‚", mapQuery: "å¤ªå®°åºœå¤©æ»¿å®®", subItems: [], image: '', notes: '' },
                { id: 'act4', time: "13:00", title: "æš–æš®æ‹‰éºµ (å¤ªå®°åºœåº—)", type: "food", description: "äº«ç”¨åœ¨åœ°äººæ°£æ‹‰éºµã€‚", mapQuery: "æš–æš®æ‹‰éºµ å¤ªå®°åºœ", subItems: [], image: '', notes: '' }
            ]},
            { day: 3, date: "4/8 (ä¸‰)", title: "è²“å³¶ & æ‹‰éºµ", activities: [
                { id: 'act5', time: "09:20", title: "ç›¸å³¶æ¸¡è¼ª", type: "ferry", description: "æ­ä¹˜æ¸¡è¼ªå‰å¾€ç›¸å³¶çœ‹è²“å’ªã€‚", mapQuery: "ç›¸å³¶æ¸¡è¼ª", subItems: [{ id: 's2', text: 'å¸¶è²“é›¶é£Ÿ', checked: false }, { id: 's3', text: 'é˜²æ›¬ä¹³', checked: false }], image: '', notes: 'å»ºè­°ææ—© 30 åˆ†é˜æ’éšŠè²·ç¥¨' },
                { id: 'act6', time: "13:50", title: "è¿”å›æ–°å®®æ¸¯", type: "ferry", description: "æ­ä¹˜æ¸¡è¼ªè¿”å›ç¦å²¡ã€‚", mapQuery: "æ–°å®®æ¸¯", subItems: [], image: '', notes: '' }
            ]},
            { day: 4, date: "4/9 (å››)", title: "å¤§æ¿  & è¿”ç¨‹", activities: [
                { id: 'act7', time: "10:00", title: "å¤§æ¿ å…¬åœ’", type: "sightseeing", description: "åœ¨æ¹–é‚Šæ•£æ­¥ï¼Œäº«å—æ—©æ™¨æ™‚å…‰ã€‚", mapQuery: "å¤§æ¿ å…¬åœ’", subItems: [], image: '', notes: '' },
                { id: 'act8', time: "13:00", title: "å‰å¾€æ©Ÿå ´", type: "plane", description: "é ç•™æ™‚é–“æ­åœ°éµåˆ°æ©Ÿå ´ã€‚", mapQuery: "ç¦å²¡æ©Ÿå ´åœ‹éš›ç·š", subItems: [], image: '', notes: '' }
            ]}
        ];
        
        const ferrySchedule = {
            toIsland: [{ time: "07:50", recommend: false }, { time: "09:20", recommend: true, note: "æ¨è–¦" }, { time: "11:30", recommend: false }, { time: "14:30", recommend: false }, { time: "17:40", recommend: false }],
            fromIsland: [{ time: "07:00", recommend: false }, { time: "08:40", recommend: false }, { time: "10:50", recommend: false }, { time: "13:50", recommend: true, note: "æ¨è–¦" }, { time: "16:00", recommend: false }, { time: "17:30", recommend: false }]
        };

        const ACTIVITY_TYPES = {
            plane: { label: "èˆªç­/äº¤é€š", icon: "plane", color: "bg-blue-500/10 text-blue-700 border-blue-200" },
            sightseeing: { label: "è§€å…‰/æ™¯é»", icon: "map-pin", color: "bg-rose-500/10 text-rose-700 border-rose-200" },
            food: { label: "ç¾é£Ÿ/é¤å»³", icon: "knife-hand", color: "bg-amber-500/10 text-amber-700 border-amber-200" },
            ferry: { label: "æ¸¡è¼ª/èˆ¹ç­", icon: "ship", color: "bg-teal-500/10 text-teal-700 border-teal-200" },
            shopping: { label: "è³¼ç‰©", icon: "shopping-bag", color: "bg-purple-500/10 text-purple-700 border-purple-200" }
        };

        // ====================================================================
        // 3. AUTH & SYNC LOGIC (é©—è­‰èˆ‡åŒæ­¥é‚è¼¯)
        // ====================================================================

        const initApp = async () => {
            try {
                // å„ªå…ˆä½¿ç”¨ç’°å¢ƒæä¾›çš„ Tokenï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
                document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500"><h1>éŒ¯èª¤ï¼šç„¡æ³•é©—è­‰ä½¿ç”¨è€…</h1><p class="mt-2">è«‹ç¢ºèªæ‚¨çš„ Firebase Authentication å·²å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ã€‚</p></div>`;
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `å…±ç”¨ ID: ${userId} (${appId})`;
                    
                    // Start Firestore Listener ONLY after successful auth
                    onSnapshot(tripDocRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            // Use saved data if available, otherwise use initial data
                            itinerary = data.itinerary && data.itinerary.length > 0 ? data.itinerary : initialItineraryData;
                            packingList = data.packingList && data.packingList.length > 0 ? data.packingList : initialPackingList;
                        } else {
                            itinerary = initialItineraryData;
                            packingList = initialPackingList;
                            saveToCloud(); // Initialize cloud data
                        }
                        isDataLoaded = true;
                        renderApp();
                    }, (error) => {
                        console.error("Sync error:", error);
                        document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500"><h1>éŒ¯èª¤ï¼šç„¡æ³•åŒæ­¥è³‡æ–™</h1><p class="mt-2">è«‹ç¢ºèªæ‚¨çš„ Firestore Database å®‰å…¨è¦å‰‡è¨­å®šæ­£ç¢ºã€‚</p></div>`;
                    });
                } else {
                    console.log("User signed out or failed to sign in.");
                }
            });
            
            renderApp();
        };

        const saveToCloud = async () => {
            if (!auth.currentUser) return;
            showSyncStatus('saving');
            try {
                const dataToSave = JSON.parse(JSON.stringify({
                    itinerary: itinerary,
                    packingList: packingList,
                    lastUpdated: new Date().toISOString()
                }));
                await setDoc(tripDocRef, dataToSave, { merge: false });
                showSyncStatus('synced');
            } catch (e) {
                console.error("Save failed:", e);
                showSyncStatus('error');
            }
        };

        const saveLocalState = () => {
            localStorage.setItem('local_activeTab', activeTab);
            localStorage.setItem('local_activeDay', activeDay);
        };

        const showSyncStatus = (status) => {
            const el = document.getElementById('syncStatus');
            el.classList.remove('hidden', 'saving');
            el.style.opacity = '1';
            
            if (status === 'saving') {
                el.innerHTML = `<div class="animate-spin rounded-full h-3 w-3 border-b-2 border-amber-500"></div><span class="text-amber-500">å„²å­˜ä¸­...</span>`;
                el.classList.add('saving');
            } else if (status === 'synced') {
                el.innerHTML = `<i data-lucide="cloud-check" class="w-4 h-4"></i><span>å·²åŒæ­¥</span>`;
                el.className = 'sync-status'; // reset color to green
                setTimeout(() => { el.style.opacity = '0'; }, 2000);
            } else {
                el.innerHTML = `<i data-lucide="wifi-off" class="w-4 h-4 text-red-500"></i><span class="text-red-500">åŒæ­¥å¤±æ•—</span>`;
            }
            if (window.lucide) lucide.createIcons();
        };

        // ====================================================================
        // 4. LLM API LOGIC (Gemini äº’å‹•é‚è¼¯)
        // ====================================================================

        // Helper for API calls with exponential backoff
        const fetchWithBackoff = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // Not rate limit, proceed
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API call failed after multiple retries.");
        };

        // LLM Feature 1: Suggest Sub-Activities (Structured JSON)
        window.generateSuggestions = async (dayNum, actId, title, desc) => {
            if (!GEMINI_API_KEY && typeof __app_id === 'undefined') {
                // Simplified notification since alerts are disallowed
                openModal(`
                    <h3 class="font-bold text-lg text-red-600 mb-2">API è­¦å‘Š</h3>
                    <p class="text-sm text-gray-700">æœªè¨­å®š Gemini API Keyï¼Œç„¡æ³•ç”Ÿæˆå»ºè­°ã€‚</p>
                    <div class="flex justify-end mt-4"><button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">é—œé–‰</button></div>
                `);
                return;
            }
            llmCache.loadingActivity = actId;
            renderApp(); // Show loading state

            const prompt = `è«‹é‡å°é€™å€‹ç¦å²¡æ—…éŠæ´»å‹•æä¾› 3 åˆ° 5 å€‹ç›¸é—œçš„ã€å¯æ·»åŠ åˆ°æ¸…å–®ä¸­çš„å»ºè­°å­è¡Œç¨‹æˆ–å¾…è¾¦äº‹é …ã€‚æ´»å‹•æ¨™é¡Œ: "${title}"ã€‚æ´»å‹•æè¿°: "${desc}"ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…éŠè¦åŠƒå¸«ã€‚è«‹æ ¹æ“šä¸»è¦çš„æ´»å‹•ï¼Œæä¾›ç›¸é—œã€å¯¦ç”¨ã€ä¸”å…·é«”çš„å°å»ºè­°ï¼Œä¾‹å¦‚ï¼šè³¼è²·ç‰¹å®šç´€å¿µå“ã€é™„è¿‘å€¼å¾—ä¸€è¨ªçš„éš±è—æ™¯é»ã€æˆ–æ˜¯ç•¶åœ°é™å®šçš„å°åƒç­‰ã€‚è«‹ä½¿ç”¨ JSON æ ¼å¼å›æ‡‰ï¼Œä¸”å›æ‡‰å…§å®¹å¿…é ˆå…¨éƒ¨ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚" }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "text": { "type": "STRING", "description": "å…·é«”ä¸”å¯åŸ·è¡Œçš„å»ºè­°æˆ–å­è¡Œç¨‹åç¨±" }
                            },
                            "propertyOrdering": ["text"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response text is empty.");
                
                const suggestions = JSON.parse(jsonText);
                
                // Add suggestions to subItems
                const day = itinerary.find(d => d.day === dayNum);
                const act = day?.activities.find(a => a.id === actId);

                if (act && Array.isArray(suggestions)) {
                    const newSubItems = suggestions.map(s => ({ 
                        id: crypto.randomUUID(), 
                        text: s.text.trim(), 
                        checked: false 
                    }));
                    
                    if (!act.subItems) act.subItems = [];
                    act.subItems.push(...newSubItems);
                    
                    saveToCloud();
                }

            } catch (error) {
                console.error("Error generating suggestions:", error);
                openModal(`
                    <h3 class="font-bold text-lg text-red-600 mb-2">ç”Ÿæˆå»ºè­°å¤±æ•—</h3>
                    <p class="text-sm text-gray-700">ç„¡æ³•å¾ AI åŠ©æ‰‹ç²å–è¡Œç¨‹å»ºè­°ã€‚è«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦ã€‚</p>
                    <div class="flex justify-end mt-4"><button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">é—œé–‰</button></div>
                `);
            } finally {
                llmCache.loadingActivity = null;
                renderApp(); // Re-render to show new items or clear loading state
            }
        };

        // LLM Feature 2: Daily Summary and Grounded Suggestions
        window.summarizeDay = async (dayNum) => {
            if (!GEMINI_API_KEY && typeof __app_id === 'undefined') {
                openModal(`
                    <h3 class="font-bold text-lg text-red-600 mb-2">API è­¦å‘Š</h3>
                    <p class="text-sm text-gray-700">æœªè¨­å®š Gemini API Keyï¼Œç„¡æ³•ç”Ÿæˆæ‘˜è¦ã€‚</p>
                    <div class="flex justify-end mt-4"><button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">é—œé–‰</button></div>
                `);
                return;
            }
            llmCache.loadingDay = dayNum;
            llmCache.daySummaries[dayNum] = { text: 'æ­£åœ¨åŠªåŠ›åˆ†æèˆ‡æœå°‹å³æ™‚è³‡è¨Š...', sources: [] };
            renderApp(); 

            const dayData = itinerary.find(d => d.day === dayNum);
            const itineraryDetails = dayData.activities.map(a => `${a.time}: ${a.title} (${getTypeLabel(a.type)}). å‚™è¨»: ${a.description}`).join('\n');
            const dateStr = dayData.date.split('(')[0].trim(); // Get '4/6'

            const userQuery = `è«‹åˆ†æä»¥ä¸‹ç¦å²¡ (Fukuoka) ${dateStr} çš„è¡Œç¨‹ï¼š\n\n${itineraryDetails}\n\nè«‹ç¶œåˆåˆ†æè¡Œç¨‹çš„åˆç†æ€§ã€æµæš¢åº¦ï¼Œä¸¦ä½¿ç”¨ Google æœå°‹å³æ™‚è³‡è¨Š (ä¾‹å¦‚ï¼šå¤©æ°£ã€äº¤é€šã€å­£ç¯€æ€§æ´»å‹•)ï¼Œæä¾›ä¸€æ®µç¸½çµèˆ‡ 2 åˆ° 3 æ¢å¯¦ç”¨ä¸”æœ‰æ™‚æ•ˆæ€§çš„å»ºè­°ã€‚`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…éŠè¦åŠƒå¸«ã€‚è«‹ä»¥ç°¡æ½”ã€å‹å¥½çš„èªæ°£ï¼Œæä¾›åˆ†æå’Œå»ºè­°ã€‚è«‹å‹¿æåŠæ‚¨ä½¿ç”¨äº† Google Searchï¼Œä½†å¿…é ˆåœ¨å›æ‡‰å¾Œé™„å¸¶å¼•ç”¨çš„ä¾†æºã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚" }]
                },
            };

            try {
                const response = await fetchWithBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text || "ç„¡æ³•ç”Ÿæˆæ‘˜è¦ã€‚";

                let sources = [];
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                llmCache.daySummaries[dayNum] = { text, sources };

            } catch (error) {
                console.error("Error generating daily summary:", error);
                llmCache.daySummaries[dayNum] = { text: 'ç”Ÿæˆæ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', sources: [] };
            } finally {
                llmCache.loadingDay = null;
                renderApp(); 
            }
        };


        // ====================================================================
        // 5. RENDER FUNCTIONS (æ¸²æŸ“å‡½å¼)
        // ====================================================================

        const renderApp = () => {
            if (!isDataLoaded) return;
            renderNavigation();
            renderContent();
            lucide.createIcons();
        };

        const renderItinerary = () => {
            const currentDayData = itinerary.find(day => day.day === activeDay);
            if (!currentDayData) return `<div class="p-4 text-center">æŸ¥ç„¡ç•¶æ—¥è³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨çš„è¡Œç¨‹è³‡æ–™æ˜¯å¦æ­£ç¢ºã€‚</div>`;

            const dayTabs = itinerary.map(day => `
                <button onclick="window.setActiveDay(${day.day})" class="flex-1 py-4 px-2 text-sm font-medium transition-all border-b-2 whitespace-nowrap ${activeDay === day.day ? 'border-rose-500 text-rose-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">
                    <div class="text-xs uppercase tracking-wider mb-1">Day ${day.day}</div><div>${day.date.split(' ')[0]}</div>
                </button>
            `).join('');

            // LLM Daily Summary Section
            const summaryData = llmCache.daySummaries[activeDay];
            const summaryHtml = summaryData ? `
                <div class="llm-suggestion-card mb-6 animate-fade-in">
                    <h4>${getIconHtml('sparkles', 18, 'text-blue-500')} ğŸ¤– AI æ—…ç¨‹åˆ†æ</h4>
                    <p>${summaryData.text}</p>
                    ${summaryData.sources.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <h5 class="text-xs font-semibold text-blue-700 mb-1">å³æ™‚è³‡è¨Šä¾†æº:</h5>
                            <ul class="text-xs space-y-1">
                                ${summaryData.sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline">${s.title}</a></li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            ` : '';
            
            const summaryButton = llmCache.loadingDay === activeDay ? `
                <button disabled class="flex items-center justify-center px-4 py-2 bg-blue-400 text-white rounded-lg font-semibold shadow-md text-sm cursor-not-allowed">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div> æ­£åœ¨åˆ†æ...
                </button>
            ` : `
                <button onclick="window.summarizeDay(${activeDay})" class="flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold shadow-lg hover:bg-blue-600 transition-all transform active:scale-95 text-sm">
                    ${getIconHtml('sparkles', 16, 'mr-1')} æ¯æ—¥æ—…ç¨‹æ‘˜è¦èˆ‡å»ºè­°
                </button>
            `;

            const activitiesHtml = (currentDayData.activities || []).map(activity => {
                const colorClass = getTypeColor(activity.type);
                const iconName = getIconName(activity.type);
                const subItemsHtml = (activity.subItems || []).map(sub => `
                    <div class="flex items-center mt-2 group/sub">
                        <input type="checkbox" id="sub-${sub.id}" ${sub.checked ? 'checked' : ''} onchange="window.toggleSubItem(${activeDay}, '${activity.id}', '${sub.id}')" class="sub-item-checkbox h-4 w-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500 cursor-pointer">
                        <label for="sub-${sub.id}" class="ml-2 text-sm text-gray-600 flex-1 cursor-pointer select-none">${sub.text}</label>
                        <button onclick="window.deleteSubItem(${activeDay}, '${activity.id}', '${sub.id}')" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover/sub:opacity-100 transition-opacity">${getIconHtml('x', 14)}</button>
                    </div>
                `).join('');

                const suggestButton = llmCache.loadingActivity === activity.id ? 
                    `<button disabled class="px-2 py-1 flex items-center text-xs text-amber-500 bg-amber-100/70 rounded-full cursor-not-allowed">
                        <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-amber-500 mr-1"></div> ç”Ÿæˆä¸­...
                    </button>` :
                    `<button onclick="window.generateSuggestions(${activeDay}, '${activity.id}', '${activity.title.replace(/'/g, "\\'")}', '${activity.description.replace(/'/g, "\\'")}')" class="px-2 py-1 flex items-center text-xs text-rose-600 bg-rose-100/70 hover:bg-rose-200/90 rounded-full transition-colors font-medium">
                        ${getIconHtml('sparkles', 12, 'mr-1')} å»ºè­°å­è¡Œç¨‹
                    </button>`;
                
                // Determine image source
                const imageSrc = activity.image && activity.image.startsWith('http') ? activity.image : 'https://placehold.co/400x120/f9f9f9/a3a3a3?text=Activity+Image';

                return `
                    <div class="relative pl-10 group" id="activity-${activity.id}">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 group-last:hidden"></div>
                        <div class="absolute left-0 top-4 w-8 h-8 rounded-full border-4 border-pink-50 shadow-md flex items-center justify-center z-10 ${colorClass.split(' ')[0]} ${colorClass.split(' ')[1]}">
                            ${getIconHtml(iconName, 18)}
                        </div>
                        <div class="bg-white rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-xl overflow-hidden mb-8">
                            <div class="h-32 w-full overflow-hidden relative group/image">
                                <img src="${imageSrc}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/400x120/f9f9f9/a3a3a3?text=No+Image';">
                                <button onclick="window.showEditActivityModal(${activeDay}, '${activity.id}')" class="absolute top-2 right-10 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-rose-600 z-20">${getIconHtml('pencil', 16)}</button>
                                <button onclick="window.deleteActivity(${activeDay}, '${activity.id}', '${activity.title}')" class="absolute top-2 right-2 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-red-600 z-20">${getIconHtml('x', 16)}</button>
                            </div>
                            <div class="p-4 relative">
                                <div class="flex justify-between items-start mb-2 pt-1">
                                    <div class="flex items-center text-gray-500 text-sm font-semibold">${getIconHtml('clock', 14, 'mr-1')} ${activity.time}</div>
                                    <span class="text-xs px-3 py-1 rounded-full font-medium border ${colorClass}">${getTypeLabel(activity.type)}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2 group-hover:text-rose-600 transition-colors">${activity.title}</h3>
                                <p class="text-gray-600 text-sm mb-4 leading-relaxed">${activity.description}</p>
                                <div class="mt-4 pt-3 border-t border-gray-100">
                                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 flex justify-between items-center">
                                        <span>è¡Œç¨‹ç´°é …</span>
                                        ${suggestButton}
                                    </h4>
                                    <div class="space-y-1 mb-3">${subItemsHtml}</div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <input type="text" id="new-sub-${activity.id}" placeholder="æ–°å¢ç´°é …..." class="flex-1 text-sm border-b border-gray-200 focus:border-rose-400 focus:outline-none py-1 px-1 bg-transparent" onkeypress="if(event.key === 'Enter') window.addSubItem(${activeDay}, '${activity.id}')">
                                        <button onclick="window.addSubItem(${activeDay}, '${activity.id}')" class="text-rose-500 hover:text-rose-700">${getIconHtml('plus-circle', 16)}</button>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-gray-100 bg-gray-50/50 -mx-4 -mb-4 p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-sm font-semibold text-gray-600 flex items-center">${getIconHtml('notebook-text', 14, 'mr-1 text-gray-500')} å‚™è¨»:</h4>
                                        <button onclick="window.showEditActivityModal(${activeDay}, '${activity.id}')" class="text-xs text-rose-500 hover:text-rose-700 flex items-center transition-colors font-medium">${getIconHtml('edit-2', 12, 'mr-1')} ç·¨è¼¯</button>
                                    </div>
                                    <p class="text-sm text-gray-700 p-2 rounded-lg bg-white border border-gray-200 break-words">${formatNotes(activity.notes)}</p>
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(activity.mapQuery)}" target="_blank" class="mt-3 flex items-center justify-center w-full py-2 bg-white hover:bg-rose-50 text-gray-600 hover:text-rose-600 rounded-lg text-sm font-medium transition-colors border border-gray-200 hover:border-rose-300 shadow-sm">${getIconHtml('map', 16, 'mr-2')} æŸ¥çœ‹åœ°åœ–</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="flex bg-white shadow-sm shrink-0 overflow-x-auto no-scrollbar sticky top-0 z-10 border-b border-gray-200">${dayTabs}</div>
                    <div class="p-4 pb-20 animate-fade-in">
                        <div class="mb-6 pt-2">
                            <h2 class="text-xl font-bold text-gray-800 mb-2">${currentDayData.title}</h2>
                            <div class="h-1 w-10 bg-rose-500 rounded-full"></div>
                        </div>
                        
                        <!-- LLM Daily Summary Section -->
                        <div class="mb-6 flex justify-center">${summaryButton}</div>
                        ${summaryHtml}

                        <div class="space-y-0 relative">${activitiesHtml}</div>
                        <div class="mt-8 text-center"><button onclick="window.showAddActivityModal(${activeDay})" class="flex items-center justify-center px-6 py-3 bg-rose-600 text-white rounded-full font-semibold shadow-lg hover:bg-rose-700 transition-all transform active:scale-95 text-sm">${getIconHtml('plus-circle', 18, 'mr-2')} + æ–°å¢æ´»å‹• (Day ${activeDay})</button></div>
                        <div class="mt-8 text-center text-gray-400 text-xs pb-4">ğŸŒ¸ è³‡æ–™å·²é€£ç·šé›²ç«¯åŒæ­¥ ğŸŒ¸</div>
                    </div>`;
        };

        const renderPacking = () => {
            const categorizedListHtml = packingList.map(categoryGroup => `
                <div class="mb-8 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-gray-500 pl-3 flex items-center">${getIconHtml('package', 18, 'mr-2 text-gray-600')} ${categoryGroup.category}</h3>
                    <div class="space-y-3">${(categoryGroup.items || []).map(item => `
                        <div class="flex items-center bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 transition-all hover:shadow-md">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="window.togglePackingItem('${item.id}')" class="form-checkbox h-5 w-5 text-gray-600 border-gray-300 rounded-md cursor-pointer checked:bg-gray-600 focus:ring-gray-500 mr-4">
                            <label class="flex-1 text-gray-800 text-base cursor-pointer ${item.checked ? 'line-through text-gray-400 italic' : 'font-medium'}">${item.text}</label>
                            <button onclick="window.deletePackingItem('${item.id}', '${item.text}')" class="text-gray-300 hover:text-red-500 ml-3 p-1">${getIconHtml('trash-2', 16)}</button>
                        </div>
                    `).join('')}</div>
                </div>
            `).join('');
            
            const categoryOptions = packingList.map(g => `<option value="${g.category}">${g.category}</option>`).join('');

            return `<div class="p-4 pb-20 animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">${getIconHtml('list-checks', 24, 'mr-2 text-gray-700')} æ—…è¡Œæ‰“åŒ…æ¸…å–®</h2>
                <div class="mb-8 space-y-4">${categorizedListHtml}</div>
                <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">${getIconHtml('plus-square', 18, 'mr-2')} æ–°å¢é …ç›®</h3>
                    <div class="space-y-3">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åˆ†é¡</label><select id="newPackingItemCategory" class="w-full p-3 border border-gray-300 rounded-lg bg-white">${categoryOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label><div class="flex space-x-2"><input type="text" id="newPackingItemText" class="flex-1 p-3 border border-gray-300 rounded-lg"><button onclick="window.addPackingItem()" class="px-4 py-3 bg-gray-600 text-white rounded-lg shadow-md active:scale-95">åŠ å…¥</button></div></div>
                    </div>
                </div>
            </div>`;
        };

        const renderFerry = () => {
            const renderTimes = (times) => times.map(item => `<div class="flex justify-between p-4 rounded-xl border ${item.recommend ? 'bg-teal-50 border-teal-300 shadow-md' : 'bg-white border-gray-200'} mb-3"><span class="text-xl font-bold text-gray-700">${item.time}</span>${item.recommend ? '<span class="text-xs bg-teal-200 px-3 py-1 rounded-full font-bold">æ¨è–¦</span>' : ''}</div>`).join('');
            return `<div class="p-4 animate-fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4">ç›¸å³¶æ¸¡è¼ªæ™‚åˆ»è¡¨</h2><div class="mb-8 p-4 bg-teal-50 rounded-xl border border-teal-200"><h3 class="font-bold text-teal-700 mb-3">å»ç¨‹ï¼šæ–°å®®æ¸¯ â†’ ç›¸å³¶</h3>${renderTimes(ferrySchedule.toIsland)}</div><div class="mb-8 p-4 bg-teal-50 rounded-xl border border-teal-200"><h3 class="font-bold text-teal-700 mb-3">å›ç¨‹ï¼šç›¸å³¶ â†’ æ–°å®®æ¸¯</h3>${renderTimes(ferrySchedule.fromIsland)}</div></div>`;
        };

        const renderContent = () => {
            const contentDiv = document.getElementById('main-content');
            if (activeTab === 'itinerary') contentDiv.innerHTML = renderItinerary();
            else if (activeTab === 'ferry') contentDiv.innerHTML = renderFerry();
            else if (activeTab === 'packing') contentDiv.innerHTML = renderPacking();
        };

        const renderNavigation = () => {
            const navDiv = document.getElementById('navigation');
            const navItems = [
                { id: 'itinerary', icon: 'route', label: 'è¡Œç¨‹ç¸½è¦½' },
                { id: 'packing', icon: 'check-square', label: 'æ‰“åŒ…æ¸…å–®' },
                { id: 'ferry', icon: 'ship', label: 'æ¸¡è¼ªæ™‚åˆ»' }
            ];
            
            navDiv.innerHTML = navItems.map(item => `
                <button onclick="window.setActiveTab('${item.id}')" class="flex flex-col items-center justify-center p-2 text-sm font-medium transition-colors ${activeTab === item.id ? 'text-rose-600' : 'text-gray-400 hover:text-rose-500'}">
                    ${getIconHtml(item.icon, 20)}
                    <span class="mt-1 text-xs">${item.label}</span>
                </button>
            `).join('');
        }

        // ====================================================================
        // 6. HELPER UTILS (è¼”åŠ©å‡½å¼)
        // ====================================================================
        
        const getIconHtml = (name, size, cls = '') => `<i data-lucide="${name}" class="w-${size/4} h-${size/4} ${cls}"></i>`;
        const getIconName = (type) => ACTIVITY_TYPES[type]?.icon || 'pin';
        const getTypeLabel = (type) => ACTIVITY_TYPES[type]?.label || 'å…¶ä»–';
        const getTypeColor = (type) => ACTIVITY_TYPES[type]?.color || 'bg-gray-100 text-gray-500 border-gray-200';

        // å‚™è¨»è¶…é€£çµè™•ç† (æ”¯æ´æ›è¡Œèˆ‡è¶…é€£çµ)
        const formatNotes = (text) => {
            if (!text) return '<span class="text-gray-400 italic">é»æ“Šã€Œç·¨è¼¯ã€åŠ å…¥é€£çµæˆ–æé†’...</span>';

            // Regex to find URLs and replace them with anchor tags
            const urlRegex = /(\b(https?:\/\/[^\s]+|www\.[^\s]+))/g;

            const linkedText = text.replace(urlRegex, (url) => {
                let actualUrl = url;
                if (url.startsWith('www.')) {
                    // Prepend https for correct linking if only www. is provided
                    actualUrl = `https://${url}`;
                }
                // Shorten display text if needed
                const display = actualUrl.length > 50 ? `${actualUrl.substring(0, 47)}...` : actualUrl;
                return `<a href="${actualUrl}" target="_blank" class="text-blue-500 hover:text-blue-600 underline">${display}</a>`;
            });

            // Replace newlines with <br> for multi-line notes
            return linkedText.replace(/\n/g, '<br>');
        };

        // ====================================================================
        // 7. INTERACTION FUNCTIONS (äº’å‹•å‡½å¼)
        // ====================================================================

        // Navigation and Day Change
        window.setActiveTab = (tabId) => {
            activeTab = tabId;
            saveLocalState();
            renderApp();
        };

        window.setActiveDay = (dayNum) => {
            activeDay = dayNum;
            saveLocalState();
            renderApp();
        };

        // Packing List Functions
        window.togglePackingItem = (id) => {
            packingList.forEach(group => {
                const item = group.items.find(i => i.id === id);
                if (item) {
                    item.checked = !item.checked;
                }
            });
            saveToCloud();
            renderApp();
        };

        window.addPackingItem = () => {
            const category = document.getElementById('newPackingItemCategory').value;
            const text = document.getElementById('newPackingItemText').value.trim();
            if (text) {
                const group = packingList.find(g => g.category === category);
                if (group) {
                    group.items.push({ id: crypto.randomUUID(), text, checked: false });
                }
                document.getElementById('newPackingItemText').value = '';
                saveToCloud();
                renderApp();
            }
        };

        window.deletePackingItem = (id, title) => {
            openModal(`
                <h3 class="font-bold text-lg text-red-600 mb-2">${getIconHtml('alert-triangle', 20)} ç¢ºèªåˆªé™¤</h3>
                <p class="text-sm text-gray-700">æ‚¨ç¢ºå®šè¦å¾æ¸…å–®ä¸­ç§»é™¤ <strong>${title}</strong> å—ï¼Ÿ</p>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button onclick="window._confirmDeletePackingItem('${id}')" class="px-3 py-1 bg-red-500 text-white rounded">ç¢ºå®šåˆªé™¤</button>
                </div>
            `);
        };

        window._confirmDeletePackingItem = (id) => {
            packingList.forEach(group => {
                group.items = group.items.filter(i => i.id !== id);
            });
            saveToCloud();
            renderApp();
            window.closeModal();
        };

        // Itinerary Activity Functions
        window.showAddActivityModal = (dayNum) => {
            openModal(`
                <h3 class="font-bold text-xl text-rose-600 mb-4">${getIconHtml('plus-circle', 20)} æ–°å¢æ´»å‹• (Day ${dayNum})</h3>
                <form id="addActivityForm" onsubmit="event.preventDefault(); window.addActivity(${dayNum})">
                    <div class="space-y-4">
                        <div>
                            <label for="addTitle" class="block text-sm font-medium text-gray-700">æ¨™é¡Œ *</label>
                            <input type="text" id="addTitle" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ä¾‹å¦‚ï¼šåšå¤šé‹æ²³åŸ">
                        </div>
                        <div>
                            <label for="addTime" class="block text-sm font-medium text-gray-700">æ™‚é–“ *</label>
                            <input type="text" id="addTime" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ä¾‹å¦‚ï¼š14:30">
                        </div>
                        <div>
                            <label for="addType" class="block text-sm font-medium text-gray-700">é¡åˆ¥ *</label>
                            <select id="addType" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                ${Object.keys(ACTIVITY_TYPES).map(key => `<option value="${key}">${ACTIVITY_TYPES[key].label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="addDescription" class="block text-sm font-medium text-gray-700">ç°¡çŸ­æè¿°</label>
                            <textarea id="addDescription" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 h-20" placeholder="ä¾‹å¦‚ï¼šäº«å—è³¼ç‰©èˆ‡ç¾é£Ÿ"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="window.closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-medium hover:bg-rose-700 transition-colors">æ–°å¢æ´»å‹•</button>
                    </div>
                </form>
            `);
        };

        window.addActivity = (dayNum) => {
            const day = itinerary.find(d => d.day === dayNum);
            if (!day) return;

            const title = document.getElementById('addTitle').value.trim();
            const time = document.getElementById('addTime').value.trim();
            const type = document.getElementById('addType').value;
            const description = document.getElementById('addDescription').value.trim();

            if (!title || !time) return;

            const newActivity = {
                id: crypto.randomUUID(),
                time: time,
                title: title,
                type: type,
                description: description,
                mapQuery: title, // Use title as default map query
                subItems: [],
                image: '', // Initialize new field for image URL
                notes: ''  // Initialize new field for notes
            };

            day.activities.push(newActivity);
            saveToCloud();
            renderApp();
            window.closeModal();
        };

        window.showEditActivityModal = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const activity = day?.activities.find(a => a.id === actId);

            if (!activity) return;

            const currentImage = activity.image || ''; 

            openModal(`
                <h3 class="font-bold text-xl text-rose-600 mb-4">${getIconHtml('pencil', 20)} ç·¨è¼¯æ´»å‹•: ${activity.title}</h3>
                <form id="editActivityForm" onsubmit="event.preventDefault(); window.editActivity(${dayNum}, '${actId}')">
                    <div class="space-y-4">
                        <div>
                            <label for="editTitle" class="block text-sm font-medium text-gray-700">æ¨™é¡Œ</label>
                            <input type="text" id="editTitle" value="${activity.title}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="editTime" class="block text-sm font-medium text-gray-700">æ™‚é–“</label>
                            <input type="text" id="editTime" value="${activity.time}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="editType" class="block text-sm font-medium text-gray-700">é¡åˆ¥</label>
                            <select id="editType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                ${Object.keys(ACTIVITY_TYPES).map(key => `<option value="${key}" ${key === activity.type ? 'selected' : ''}>${ACTIVITY_TYPES[key].label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="editDescription" class="block text-sm font-medium text-gray-700">ç°¡çŸ­æè¿°</label>
                            <textarea id="editDescription" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 h-20">${activity.description}</textarea>
                        </div>
                        <div>
                            <label for="editMapQuery" class="block text-sm font-medium text-gray-700">åœ°åœ–æœå°‹é—œéµå­—</label>
                            <input type="text" id="editMapQuery" value="${activity.mapQuery}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="border-t pt-4">
                            <label for="editImage" class="block text-sm font-medium text-gray-700">åœ–ç‰‡ URL (å¯é¸)</label>
                            <input type="text" id="editImage" value="${currentImage}" placeholder="è¼¸å…¥æ´»å‹•åœ–ç‰‡ç¶²å€ (http/https é–‹é ­)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="border-t pt-4">
                            <label for="editNotes" class="block text-sm font-medium text-gray-700">å‚™è¨» (æ”¯æ´æ›è¡Œèˆ‡è¶…é€£çµ)</label>
                            <textarea id="editNotes" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 h-24" placeholder="ä¾‹å¦‚ï¼šæé†’ã€äº¤é€šè³‡è¨Šæˆ–é€£çµ">${activity.notes || ''}</textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="window.closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
                        <button type="submit" class="px-4 py-2 bg-rose-600 text-white rounded-lg font-medium hover:bg-rose-700 transition-colors">å„²å­˜è®Šæ›´</button>
                    </div>
                </form>
            `);
        };

        window.editActivity = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const activity = day?.activities.find(a => a.id === actId);

            if (activity) {
                activity.title = document.getElementById('editTitle').value.trim();
                activity.time = document.getElementById('editTime').value.trim();
                activity.type = document.getElementById('editType').value;
                activity.description = document.getElementById('editDescription').value.trim();
                activity.mapQuery = document.getElementById('editMapQuery').value.trim();
                activity.image = document.getElementById('editImage').value.trim(); 
                activity.notes = document.getElementById('editNotes').value; // Keep newlines
                
                saveToCloud();
                renderApp();
                window.closeModal();
            }
        };

        window.deleteActivity = (dayNum, actId, title) => {
            openModal(`
                <h3 class="font-bold text-lg text-red-600 mb-2">${getIconHtml('alert-triangle', 20)} ç¢ºèªåˆªé™¤</h3>
                <p class="text-sm text-gray-700">æ‚¨ç¢ºå®šè¦åˆªé™¤ <strong>${title}</strong> å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚</p>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button onclick="window._confirmDeleteActivity(${dayNum}, '${actId}')" class="px-3 py-1 bg-red-500 text-white rounded">ç¢ºå®šåˆªé™¤</button>
                </div>
            `);
        };

        window._confirmDeleteActivity = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            if (day) {
                day.activities = day.activities.filter(a => a.id !== actId);
                saveToCloud();
                renderApp();
            }
            window.closeModal();
        };

        window.addSubItem = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const activity = day?.activities.find(a => a.id === actId);
            const inputEl = document.getElementById(`new-sub-${actId}`);
            const text = inputEl?.value.trim();

            if (activity && text) {
                if (!activity.subItems) activity.subItems = [];
                activity.subItems.push({ id: crypto.randomUUID(), text, checked: false });
                inputEl.value = '';
                saveToCloud();
                renderApp();
            }
        };

        window.toggleSubItem = (dayNum, actId, subId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const activity = day?.activities.find(a => a.id === actId);
            const sub = activity?.subItems.find(s => s.id === subId);
            
            if (sub) {
                sub.checked = !sub.checked;
                saveToCloud();
                renderApp();
            }
        };
        
        window.deleteSubItem = (dayNum, actId, subId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const activity = day?.activities.find(a => a.id === actId);
            
            if (activity) {
                activity.subItems = activity.subItems.filter(s => s.id !== subId);
                saveToCloud();
                renderApp();
            }
        };

        // Modal Functions
        window.openModal = (contentHtml) => {
            const backdrop = document.getElementById('modal-backdrop');
            const content = document.getElementById('modal-content');
            content.innerHTML = contentHtml;
            backdrop.classList.add('open');
            if (window.lucide) lucide.createIcons();
        };

        window.closeModal = (event) => {
            const backdrop = document.getElementById('modal-backdrop');
            if (!event || event.target === backdrop) {
                backdrop.classList.remove('open');
            }
        };


        // ====================================================================
        // 8. INITIALIZATION (å•Ÿå‹•)
        // ====================================================================

        window.onload = initApp;
    </script>
</body>
</html>

