<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦å²¡æ—…éŠå°å¹«æ‰‹ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN for visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ (æ—¥ç³»ç°¡ç´„ï¼Œéš±è—æ»¾å‹•æ¢) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* å®šç¾©éæ¸¡å‹•ç•« */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 420px;
            max-height: 90vh; 
            overflow-y: auto; 
            transform: translateY(-30px);
            transition: transform 0.3s ease;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); 
        }
        .modal-backdrop.open .modal-content {
            transform: translateY(0);
        }
        /* Sub-item specific styles */
        .sub-item-checkbox:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }
        /* Sync Indicator */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #10b981; /* Green */
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 60;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        .sync-status.saving {
            color: #f59e0b; /* Amber */
        }
        .firebase-status {
            font-size: 0.75rem;
            color: #eab308; /* yellow-500 */
            background-color: #fef3c7; /* yellow-100 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-pink-50 antialiased h-screen flex flex-col">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="max-w-md mx-auto bg-white h-full flex flex-col font-sans text-gray-800 shadow-2xl overflow-hidden relative">
        
        <!-- Header -->
        <div id="header" class="bg-gradient-to-br from-rose-400 to-pink-300 p-6 text-white shrink-0 shadow-lg z-20">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">ç¦å²¡æ«»èŠ±ç´€è¡Œ</h1>
                    <p class="text-pink-100 text-sm mt-1">é›²ç«¯åŒæ­¥ç‰ˆ â€¢ 4å¤©3å¤œ</p>
                </div>
                <div class="p-2 rounded-xl border border-white/40 backdrop-blur-sm">
                    <i data-lucide="cloud" class="w-6 h-6 text-white"></i>
                </div>
            </div>
            <!-- Firebase Config Warning/Status -->
            <div id="config-status" class="mt-3">
                <!-- Status will be injected by JavaScript -->
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="scroll-container z-10 bg-pink-50">
            <!-- Content will be rendered here by JavaScript -->
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-500 mx-auto mb-2"></div>
                    <p>æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="navigation" class="bg-white border-t border-gray-100 shrink-0 w-full flex justify-around items-center h-16 z-30 shadow-t-lg">
            <!-- Navigation buttons will be rendered here by JavaScript -->
        </div>
        
        <!-- Sync Status Indicator -->
        <div id="syncStatus" class="sync-status hidden">
            <i data-lucide="cloud-check" class="w-4 h-4"></i>
            <span>å·²åŒæ­¥</span>
        </div>

        <!-- Modal Structure -->
        <div id="modal-backdrop" class="modal-backdrop" onclick="closeModal(event)">
            <div id="modal-content" class="modal-content" onclick="event.stopPropagation()">
                <!-- Modal content will be injected here -->
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // 1. FIREBASE CONFIGURATION (é›²ç«¯è¨­å®š)
        // ====================================================================
        
        // âš ï¸ éƒ¨ç½²åˆ° GitHub Pages æ™‚ï¼Œè«‹å°‡ä¸‹æ–¹çš„ config æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®š
        const isUsingDefaultConfig = typeof __firebase_config === 'undefined' || !Object.keys(JSON.parse(__firebase_config) || {}).length;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // é€™æ˜¯ä¸€å€‹ç¯„ä¾‹è¨­å®šï¼Œéƒ¨ç½²æ™‚è«‹å‹™å¿…æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Config!
           apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
  authDomain: "fuktrip.firebaseapp.com",
  projectId: "fuktrip",
  storageBucket: "fuktrip.firebasestorage.app",
  messagingSenderId: "663462561018",
  appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
  measurementId: "G-KME94X3EKH"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fukuoka-trip';
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Document Reference for Shared Data
        // ä½¿ç”¨ 'public/data/fukuoka_trip/shared_plan' è·¯å¾‘ä¾†å„²å­˜å…±ç”¨è¡Œç¨‹
        const tripDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'fukuoka_trip', 'shared_plan');

        // ====================================================================
        // 2. STATE MANAGEMENT (ç‹€æ…‹ç®¡ç†)
        // ====================================================================

        // UI ç‹€æ…‹ (å­˜åœ¨æœ¬åœ°ï¼Œä¸éœ€è¦åŒæ­¥)
        let activeTab = localStorage.getItem('local_activeTab') || 'itinerary';
        let activeDay = parseInt(localStorage.getItem('local_activeDay') || '1');
        let tempImageBase64 = '';

        // å…±äº«è³‡æ–™ (å¾ Firebase åŒæ­¥)
        let itinerary = []; 
        let packingList = [];
        let isDataLoaded = false;
        let authError = false;

        // é è¨­è³‡æ–™ (ç•¶é›²ç«¯æ²’æœ‰è³‡æ–™æ™‚ä½¿ç”¨)
        const initialPackingList = [
            { category: 'æ–‡ä»¶èˆ‡é‡‘éŒ¢', items: [{ id: 'p1', text: 'è­·ç…§', checked: false }, { id: 'p2', text: 'æ—¥å¹£ç¾é‡‘', checked: false }] },
            { category: 'é›»å­ç”¢å“', items: [{ id: 'p4', text: 'ç¶²å¡/SIMå¡', checked: false }, { id: 'p5', text: 'è¡Œå‹•é›»æº', checked: false }] },
            { category: 'è¡£ç‰©èˆ‡ç”¨å“', items: [{ id: 'p7', text: 'å¥½èµ°çš„é‹', checked: false }, { id: 'p8', text: 'é›¨å…·', checked: false }] },
            { category: 'è—¥å“', items: [{ id: 'p10', text: 'å¸¸å‚™è—¥', checked: false }] }
        ];

        const initialItineraryData = [
            { day: 1, date: "4/6 (ä¸€)", title: "æŠµé”ç¦å²¡ - FUK", activities: [
                { id: 'act1', time: "14:00", title: "æŠµé”ç¦å²¡æ©Ÿå ´", type: "plane", description: "é ˜å–è¡ŒæåŠç¶²å¡ï¼Œæ­ä¹˜åœ°éµå‰å¾€é£¯åº—ã€‚", mapQuery: "ç¦å²¡æ©Ÿå ´åœ‹éš›ç·š", subItems: [{ id: 's1', text: 'è³¼è²·åœ°éµä¸€æ—¥åˆ¸', checked: false }] },
                { id: 'act2', time: "16:00", title: "ä¸­æ´²å·ç«¯å•†åº—è¡—", type: "sightseeing", description: "åˆ°é£¯åº— Check-in å¾Œï¼Œå‰å¾€ä¸­æ´²å·ç«¯å•†åº—è¡—é€›é€›ã€‚", mapQuery: "ä¸­æ´²å·ç«¯å•†åº—è¡—", subItems: [] }
            ]},
            { day: 2, date: "4/7 (äºŒ)", title: "å¤ªå®°åºœ & è³æ«»", activities: [
                { id: 'act3', time: "09:00", title: "å¤ªå®°åºœå¤©æ»¿å®®", type: "sightseeing", description: "åƒæ‹œå­¸å•ä¹‹ç¥ï¼Œé †é“åƒæ¢…æé¤…ã€‚", mapQuery: "å¤ªå®°åºœå¤©æ»¿å®®", subItems: [] },
                { id: 'act4', time: "13:00", title: "æš–æš®æ‹‰éºµ (å¤ªå®°åºœåº—)", type: "food", description: "äº«ç”¨åœ¨åœ°äººæ°£æ‹‰éºµã€‚", mapQuery: "æš–æš®æ‹‰éºµ å¤ªå®°åºœ", subItems: [] }
            ]},
            { day: 3, date: "4/8 (ä¸‰)", title: "è²“å³¶ & æ‹‰éºµ", activities: [
                { id: 'act5', time: "09:20", title: "ç›¸å³¶æ¸¡è¼ª", type: "ferry", description: "æ­ä¹˜æ¸¡è¼ªå‰å¾€ç›¸å³¶çœ‹è²“å’ªã€‚", mapQuery: "ç›¸å³¶æ¸¡è¼ª", subItems: [{ id: 's2', text: 'å¸¶è²“é›¶é£Ÿ', checked: false }, { id: 's3', text: 'é˜²æ›¬ä¹³', checked: false }] },
                { id: 'act6', time: "13:50", title: "è¿”å›æ–°å®®æ¸¯", type: "ferry", description: "æ­ä¹˜æ¸¡è¼ªè¿”å›ç¦å²¡ã€‚", mapQuery: "æ–°å®®æ¸¯", subItems: [] }
            ]},
            { day: 4, date: "4/9 (å››)", title: "å¤§æ¿  & è¿”ç¨‹", activities: [
                { id: 'act7', time: "10:00", title: "å¤§æ¿ å…¬åœ’", type: "sightseeing", description: "åœ¨æ¹–é‚Šæ•£æ­¥ï¼Œäº«å—æ—©æ™¨æ™‚å…‰ã€‚", mapQuery: "å¤§æ¿ å…¬åœ’", subItems: [] },
                { id: 'act8', time: "13:00", title: "å‰å¾€æ©Ÿå ´", type: "plane", description: "é ç•™æ™‚é–“æ­åœ°éµåˆ°æ©Ÿå ´ã€‚", mapQuery: "ç¦å²¡æ©Ÿå ´åœ‹éš›ç·š", subItems: [] }
            ]}
        ];
        
        // æ¸¡è¼ªæ™‚åˆ»è¡¨ (éœæ…‹è³‡æ–™ï¼Œä¸éœ€åŒæ­¥)
        const ferrySchedule = {
            toIsland: [{ time: "07:50", recommend: false }, { time: "09:20", recommend: true, note: "æ¨è–¦" }, { time: "11:30", recommend: false }, { time: "14:30", recommend: false }, { time: "17:40", recommend: false }],
            fromIsland: [{ time: "07:00", recommend: false }, { time: "08:40", recommend: false }, { time: "10:50", recommend: false }, { time: "13:50", recommend: true, note: "æ¨è–¦" }, { time: "16:00", recommend: false }, { time: "17:30", recommend: false }]
        };

        // ====================================================================
        // 3. AUTH & SYNC LOGIC (é©—è­‰èˆ‡åŒæ­¥é‚è¼¯)
        // ====================================================================

        const renderConfigStatus = () => {
            const el = document.getElementById('config-status');
            if (isUsingDefaultConfig) {
                el.innerHTML = `<div class="firebase-status text-yellow-500 bg-yellow-100 border border-yellow-300"><i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-600"></i><strong>éƒ¨ç½²è­¦å‘Š:</strong> ç›®å‰ä½¿ç”¨é è¨­è¨­å®šã€‚è«‹æ›¿æ›æˆæ‚¨çš„ Firebase Config ä»¥å•Ÿç”¨åŒæ­¥ã€‚</div>`;
            } else if (authError) {
                 el.innerHTML = `<div class="firebase-status text-red-500 bg-red-100 border border-red-300"><i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i><strong>é€£ç·šéŒ¯èª¤:</strong> ç„¡æ³•é€£æ¥åˆ° Firebaseã€‚è«‹æª¢æŸ¥æ‚¨çš„ Config å’Œè³‡æ–™åº«å®‰å…¨è¦å‰‡ã€‚</div>`;
            } else {
                el.innerHTML = `<div class="text-xs text-pink-100/70 flex items-center gap-1"><i data-lucide="key-round" class="w-3 h-3"></i>å·²é€£ç·šå°ˆæ¡ˆ ID: ${firebaseConfig.projectId}</div>`;
            }
            if (window.lucide) lucide.createIcons();
        }

        const initApp = async () => {
            renderConfigStatus();
            
            // 1. Authentication
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // è‹¥ç„¡ tokenï¼Œä½¿ç”¨åŒ¿åç™»å…¥ (éœ€è¦ Firebase Authentication å•Ÿç”¨ Anonymous Sign-in)
                    await signInAnonymously(auth);
                }
                console.log("Logged in successfully for shared access.");
            } catch (error) {
                console.error("Auth failed:", error);
                authError = true;
                renderConfigStatus();
                document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500"><h1>éŒ¯èª¤ï¼šç„¡æ³•é©—è­‰ä½¿ç”¨è€…</h1><p class="mt-2">è«‹ç¢ºèªæ‚¨çš„ Firebase Authentication å·²å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ã€‚</p></div>`;
                return;
            }

            // 2. Setup Real-time Listener
            onSnapshot(tripDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // è³‡æ–™å­˜åœ¨ï¼Œæ›´æ–°æœ¬åœ°ç‹€æ…‹
                    const data = docSnapshot.data();
                    itinerary = data.itinerary && data.itinerary.length > 0 ? data.itinerary : initialItineraryData;
                    packingList = data.packingList && data.packingList.length > 0 ? data.packingList : initialPackingList;
                    console.log("Received update from cloud. Data loaded.");
                } else {
                    // è³‡æ–™ä¸å­˜åœ¨ (ç¬¬ä¸€æ¬¡ä½¿ç”¨æˆ–è¢«æ¸…ç©º)ï¼Œå¯«å…¥é è¨­è³‡æ–™
                    console.log("No data found, initializing default data to cloud.");
                    itinerary = initialItineraryData;
                    packingList = initialPackingList;
                    saveToCloud(); // å¯«å…¥é›²ç«¯
                }
                isDataLoaded = true;
                renderApp();
            }, (error) => {
                console.error("Sync error:", error);
                authError = true;
                renderConfigStatus();
                document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500"><h1>éŒ¯èª¤ï¼šç„¡æ³•åŒæ­¥è³‡æ–™</h1><p class="mt-2">è«‹ç¢ºèªæ‚¨çš„ Firestore Database å®‰å…¨è¦å‰‡è¨­å®šæ­£ç¢º (ä¾‹å¦‚ï¼šæ¸¬è©¦æ¨¡å¼)ã€‚</p></div>`;
            });
            
            // Initial Render
            renderApp();
        };

        // å„²å­˜è³‡æ–™åˆ°é›²ç«¯
        const saveToCloud = async () => {
            if (!auth.currentUser || authError) return;
            
            showSyncStatus('saving');
            try {
                // å°‡ JS ç‰©ä»¶è½‰ç‚ºç´” JSON ç‰©ä»¶ä»¥ç¢ºä¿ç›¸å®¹æ€§
                const dataToSave = JSON.parse(JSON.stringify({
                    itinerary: itinerary,
                    packingList: packingList,
                    lastUpdated: new Date().toISOString()
                }));
                
                await setDoc(tripDocRef, dataToSave, { merge: false }); // ä½¿ç”¨ merge: false å®Œæ•´è¦†è“‹
                showSyncStatus('synced');
            } catch (e) {
                console.error("Save failed:", e);
                showSyncStatus('error');
            }
        };

        // UI ç‹€æ…‹å„²å­˜ (LocalStorage)
        const saveLocalState = () => {
            localStorage.setItem('local_activeTab', activeTab);
            localStorage.setItem('local_activeDay', activeDay);
        };

        // åŒæ­¥ç‹€æ…‹é¡¯ç¤º
        const showSyncStatus = (status) => {
            const el = document.getElementById('syncStatus');
            el.classList.remove('hidden', 'saving');
            el.style.opacity = '1';
            
            if (status === 'saving') {
                el.innerHTML = `<div class="animate-spin rounded-full h-3 w-3 border-b-2 border-amber-500"></div><span class="text-amber-500">å„²å­˜ä¸­...</span>`;
                el.classList.add('saving');
            } else if (status === 'synced') {
                el.innerHTML = `<i data-lucide="cloud-check" class="w-4 h-4"></i><span>å·²åŒæ­¥</span>`;
                el.className = 'sync-status'; // reset color to green
                // 2ç§’å¾Œæ·¡å‡º
                setTimeout(() => { el.style.opacity = '0'; }, 2000);
            } else {
                el.innerHTML = `<i data-lucide="wifi-off" class="w-4 h-4 text-red-500"></i><span class="text-red-500">åŒæ­¥å¤±æ•—</span>`;
            }
            if (window.lucide) lucide.createIcons();
        };

        // ====================================================================
        // 4. RENDER FUNCTIONS (æ¸²æŸ“å‡½å¼)
        // ====================================================================

        const renderApp = () => {
            if (!isDataLoaded) return; // ç­‰å¾…è³‡æ–™è¼‰å…¥
            renderConfigStatus(); // Re-render status after loading
            renderNavigation();
            renderContent();
            lucide.createIcons();
        };

        const renderNavigation = () => {
            const nav = document.getElementById('navigation');
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'calendar', color: 'rose' },
                { id: 'ferry', label: 'æ¸¡è¼ªè³‡è¨Š', icon: 'anchor', color: 'teal' },
                { id: 'packing', label: 'æ¸…å–®', icon: 'list-checks', color: 'gray' }
            ];
            nav.innerHTML = tabs.map(tab => `
                <button onclick="window.setActiveTab('${tab.id}')" class="flex flex-col items-center justify-center w-full h-full transition-colors ${activeTab === tab.id ? (tab.id === 'packing' ? 'text-gray-800' : `text-${tab.color}-600`) : 'text-gray-400 hover:text-gray-600'}">
                    ${getIconHtml(tab.icon, 20, 'mb-1')} <span class="text-xs font-medium">${tab.label}</span>
                </button>
            `).join('');
        };

        const renderItinerary = () => {
            const currentDayData = itinerary.find(day => day.day === activeDay);
            if (!currentDayData) return `<div class="p-4 text-center">æŸ¥ç„¡ç•¶æ—¥è³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨çš„è¡Œç¨‹è³‡æ–™æ˜¯å¦æ­£ç¢ºã€‚</div>`;

            const dayTabs = itinerary.map(day => `
                <button onclick="window.setActiveDay(${day.day})" class="flex-1 py-4 px-2 text-sm font-medium transition-all border-b-2 whitespace-nowrap ${activeDay === day.day ? 'border-rose-500 text-rose-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}">
                    <div class="text-xs uppercase tracking-wider mb-1">Day ${day.day}</div><div>${day.date.split(' ')[0]}</div>
                </button>
            `).join('');

            const activitiesHtml = (currentDayData.activities || []).map(activity => {
                const colorClass = getTypeColor(activity.type);
                const iconName = getIconName(activity.type);
                const subItemsHtml = (activity.subItems || []).map(sub => `
                    <div class="flex items-center mt-2 group/sub">
                        <input type="checkbox" id="sub-${sub.id}" ${sub.checked ? 'checked' : ''} onchange="window.toggleSubItem(${activeDay}, '${activity.id}', '${sub.id}')" class="sub-item-checkbox h-4 w-4 text-rose-500 rounded border-gray-300 focus:ring-rose-500 cursor-pointer">
                        <label for="sub-${sub.id}" class="ml-2 text-sm text-gray-600 flex-1 cursor-pointer select-none">${sub.text}</label>
                        <button onclick="window.deleteSubItem(${activeDay}, '${activity.id}', '${sub.id}')" class="text-gray-300 hover:text-red-400 p-1 opacity-0 group-hover/sub:opacity-100 transition-opacity">${getIconHtml('x', 14)}</button>
                    </div>
                `).join('');

                return `
                    <div class="relative pl-10 group" id="activity-${activity.id}">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200 group-last:hidden"></div>
                        <div class="absolute left-0 top-4 w-8 h-8 rounded-full border-4 border-pink-50 shadow-md flex items-center justify-center z-10 ${colorClass.split(' ')[0]} ${colorClass.split(' ')[1]}">
                            ${getIconHtml(iconName, 18)}
                        </div>
                        <div class="bg-white rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-xl overflow-hidden mb-8">
                            <div class="h-32 w-full overflow-hidden relative group/image">
                                <img src="${activity.image || 'https://placehold.co/400x120/f9f9f9/a3a3a3?text=Activity'}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/400x120/f9f9f9/a3a3a3?text=No+Image';">
                                <button onclick="window.showEditActivityModal(${activeDay}, '${activity.id}')" class="absolute top-2 right-10 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-rose-600 z-20">${getIconHtml('pencil', 16)}</button>
                                <button onclick="window.deleteActivity(${activeDay}, '${activity.id}', '${activity.title}')" class="absolute top-2 right-2 text-gray-700 bg-white/90 hover:bg-white p-1.5 rounded-lg shadow-sm transition-all hover:text-red-600 z-20">${getIconHtml('x', 16)}</button>
                            </div>
                            <div class="p-4 relative">
                                <div class="flex justify-between items-start mb-2 pt-1">
                                    <div class="flex items-center text-gray-500 text-sm font-semibold">${getIconHtml('clock', 14, 'mr-1')} ${activity.time}</div>
                                    <span class="text-xs px-3 py-1 rounded-full font-medium border ${colorClass}">${getTypeLabel(activity.type)}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2 group-hover:text-rose-600 transition-colors">${activity.title}</h3>
                                <p class="text-gray-600 text-sm mb-4 leading-relaxed">${activity.description}</p>
                                <div class="mt-4 pt-3 border-t border-gray-100">
                                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">è¡Œç¨‹ç´°é …</h4>
                                    <div class="space-y-1 mb-3">${subItemsHtml}</div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <input type="text" id="new-sub-${activity.id}" placeholder="æ–°å¢ç´°é …..." class="flex-1 text-sm border-b border-gray-200 focus:border-rose-400 focus:outline-none py-1 px-1 bg-transparent" onkeypress="if(event.key === 'Enter') window.addSubItem(${activeDay}, '${activity.id}')">
                                        <button onclick="window.addSubItem(${activeDay}, '${activity.id}')" class="text-rose-500 hover:text-rose-700">${getIconHtml('plus-circle', 16)}</button>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-gray-100 bg-gray-50/50 -mx-4 -mb-4 p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-sm font-semibold text-gray-600 flex items-center">${getIconHtml('notebook-text', 14, 'mr-1 text-gray-500')} å‚™è¨»:</h4>
                                        <button onclick="window.showEditNotesModal(${activeDay}, '${activity.id}')" class="text-xs text-rose-500 hover:text-rose-700 flex items-center transition-colors font-medium">${getIconHtml('edit-2', 12, 'mr-1')} ç·¨è¼¯</button>
                                    </div>
                                    <p class="text-sm text-gray-700 p-2 rounded-lg bg-white border border-gray-200 break-words">${activity.notes ? formatNotes(activity.notes) : '<span class="text-gray-400 italic">é»æ“Šã€Œç·¨è¼¯ã€åŠ å…¥é€£çµæˆ–æé†’...</span>'}</p>
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(activity.mapQuery)}" target="_blank" class="mt-3 flex items-center justify-center w-full py-2 bg-white hover:bg-rose-50 text-gray-600 hover:text-rose-600 rounded-lg text-sm font-medium transition-colors border border-gray-200 hover:border-rose-300 shadow-sm">${getIconHtml('map', 16, 'mr-2')} æŸ¥çœ‹åœ°åœ–</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="flex bg-white shadow-sm shrink-0 overflow-x-auto no-scrollbar sticky top-0 z-10 border-b border-gray-200">${dayTabs}</div>
                    <div class="p-4 pb-20 animate-fade-in">
                        <div class="mb-6 pt-2"><h2 class="text-xl font-bold text-gray-800 mb-2">${currentDayData.title}</h2><div class="h-1 w-10 bg-rose-500 rounded-full"></div></div>
                        <div class="space-y-0 relative">${activitiesHtml}</div>
                        <div class="mt-8 text-center"><button onclick="window.showAddActivityModal(${activeDay})" class="flex items-center justify-center px-6 py-3 bg-rose-600 text-white rounded-full font-semibold shadow-lg hover:bg-rose-700 transition-all transform active:scale-95 text-sm">${getIconHtml('plus-circle', 18, 'mr-2')} + æ–°å¢æ´»å‹• (Day ${activeDay})</button></div>
                        <div class="mt-8 text-center text-gray-400 text-xs pb-4">ğŸŒ¸ è³‡æ–™å·²é€£ç·šé›²ç«¯åŒæ­¥ ğŸŒ¸</div>
                    </div>`;
        };

        // ç°¡åŒ– Packing, Ferry ç­‰æ¸²æŸ“ä»£ç¢¼
        const renderPacking = () => {
            const categorizedListHtml = packingList.map(categoryGroup => `
                <div class="mb-8 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-gray-500 pl-3 flex items-center">${getIconHtml('package', 18, 'mr-2 text-gray-600')} ${categoryGroup.category}</h3>
                    <div class="space-y-3">${(categoryGroup.items || []).map(item => `
                        <div class="flex items-center bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 transition-all hover:shadow-md">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="window.togglePackingItem('${item.id}')" class="form-checkbox h-5 w-5 text-gray-600 border-gray-300 rounded-md cursor-pointer checked:bg-gray-600 focus:ring-gray-500 mr-4">
                            <label class="flex-1 text-gray-800 text-base cursor-pointer ${item.checked ? 'line-through text-gray-400 italic' : 'font-medium'}">${item.text}</label>
                            <button onclick="window.deletePackingItem('${item.id}', '${item.text}')" class="text-gray-300 hover:text-red-500 ml-3 p-1">${getIconHtml('trash-2', 16)}</button>
                        </div>
                    `).join('')}</div>
                </div>
            `).join('');
            
            const categoryOptions = packingList.map(g => `<option value="${g.category}">${g.category}</option>`).join('');

            return `<div class="p-4 pb-20 animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">${getIconHtml('list-checks', 24, 'mr-2 text-gray-700')} æ—…è¡Œæ‰“åŒ…æ¸…å–®</h2>
                <div class="mb-8 space-y-4">${categorizedListHtml}</div>
                <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">${getIconHtml('plus-square', 18, 'mr-2')} æ–°å¢é …ç›®</h3>
                    <div class="space-y-3">
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡åˆ†é¡</label><select id="newPackingItemCategory" class="w-full p-3 border border-gray-300 rounded-lg bg-white">${categoryOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label><div class="flex space-x-2"><input type="text" id="newPackingItemText" class="flex-1 p-3 border border-gray-300 rounded-lg"><button onclick="window.addPackingItem()" class="px-4 py-3 bg-gray-600 text-white rounded-lg shadow-md active:scale-95">åŠ å…¥</button></div></div>
                    </div>
                </div>
            </div>`;
        };

        const renderFerry = () => {
            const renderTimes = (times) => times.map(item => `<div class="flex justify-between p-4 rounded-xl border ${item.recommend ? 'bg-teal-50 border-teal-300 shadow-md' : 'bg-white border-gray-200'} mb-3"><span class="text-xl font-bold text-gray-700">${item.time}</span>${item.recommend ? '<span class="text-xs bg-teal-200 px-3 py-1 rounded-full font-bold">æ¨è–¦</span>' : ''}</div>`).join('');
            return `<div class="p-4 animate-fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4">ç›¸å³¶æ¸¡è¼ªæ™‚åˆ»è¡¨</h2><div class="mb-8 p-4 bg-teal-50 rounded-xl border border-teal-200"><h3 class="font-bold text-teal-700 mb-3">å»ç¨‹ï¼šæ–°å®®æ¸¯ â†’ ç›¸å³¶</h3>${renderTimes(ferrySchedule.toIsland)}</div><div class="mb-8 p-4 bg-teal-50 rounded-xl border border-teal-200"><h3 class="font-bold text-teal-700 mb-3">å›ç¨‹ï¼šç›¸å³¶ â†’ æ–°å®®æ¸¯</h3>${renderTimes(ferrySchedule.fromIsland)}</div></div>`;
        };

        const renderContent = () => {
            const contentDiv = document.getElementById('main-content');
            if (activeTab === 'itinerary') contentDiv.innerHTML = renderItinerary();
            else if (activeTab === 'ferry') contentDiv.innerHTML = renderFerry();
            else if (activeTab === 'packing') contentDiv.innerHTML = renderPacking();
        };

        // ====================================================================
        // 5. HELPER UTILS (è¼”åŠ©å‡½å¼)
        // ====================================================================
        
        const getIconHtml = (name, size, cls = '') => `<i data-lucide="${name}" class="w-${size/4} h-${size/4} ${cls}"></i>`;
        const getIconName = (type) => {
            if(type==='food') return 'utensils';
            if(type==='transport') return 'train';
            if(type==='sightseeing') return 'camera';
            if(type==='shopping') return 'shopping-bag';
            if(type==='ferry') return 'anchor';
            if(type==='plane') return 'plane';
            if(type==='hotel') return 'moon';
            return 'info';
        };
        const getTypeColor = (type) => {
            if(type==='transport'||type==='ferry') return 'bg-teal-100 text-teal-700 border-teal-200';
            if(type==='food') return 'bg-yellow-100 text-yellow-700 border-yellow-200';
            if(type==='sightseeing') return 'bg-rose-100 text-rose-700 border-rose-200';
            return 'bg-gray-100 text-gray-700 border-gray-200';
        };
        const getTypeLabel = (type) => {
            const map = {food:'ç¾é£Ÿ', transport:'äº¤é€š', sightseeing:'æ™¯é»', shopping:'è³¼ç‰©', ferry:'æ¸¡è¼ª', plane:'é£›æ©Ÿ', hotel:'ä½å®¿', activity:'æ´»å‹•'};
            return map[type] || 'ä¸€èˆ¬';
        };
        const formatNotes = (text) => {
            if (!text) return '';
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            safeText = safeText.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, `<a href="$2" target="_blank" class="text-blue-600 hover:underline" onclick="event.stopPropagation()">$1</a>`);
            safeText = safeText.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, `<a href="$1" target="_blank" class="text-blue-600 hover:underline" onclick="event.stopPropagation()">$1</a>`);
            return safeText.replace(/\n/g, '<br>');
        };

        // ====================================================================
        // 6. GLOBAL INTERACTIONS (å…¨åŸŸäº’å‹• - æ›è¼‰åˆ° window)
        // ====================================================================

        window.setActiveTab = (id) => { activeTab = id; saveLocalState(); renderApp(); };
        window.setActiveDay = (day) => { activeDay = day; saveLocalState(); renderApp(); };
        
        window.togglePackingItem = (id) => {
            for(let group of packingList) {
                const item = group.items.find(i => i.id === id);
                if(item) { item.checked = !item.checked; saveToCloud(); renderApp(); break; }
            }
        };
        
        window.addPackingItem = () => {
            const cat = document.getElementById('newPackingItemCategory').value;
            const text = document.getElementById('newPackingItemText').value.trim();
            if(!text) return;
            const group = packingList.find(g => g.category === cat) || packingList[0];
            group.items.push({ id: crypto.randomUUID(), text, checked: false });
            document.getElementById('newPackingItemText').value = '';
            saveToCloud();
            renderApp();
        };

        window.deletePackingItem = (id, name) => {
            if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) {
                for(let group of packingList) {
                    group.items = group.items.filter(i => i.id !== id);
                }
                saveToCloud();
                renderApp();
            }
        };

        // Sub Items
        window.toggleSubItem = (dayNum, actId, subId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const act = day?.activities.find(a => a.id === actId);
            const sub = act?.subItems?.find(s => s.id === subId);
            if(sub) { sub.checked = !sub.checked; saveToCloud(); renderApp(); }
        };
        window.addSubItem = (dayNum, actId) => {
            const text = document.getElementById(`new-sub-${actId}`).value.trim();
            if(!text) return;
            const day = itinerary.find(d => d.day === dayNum);
            const act = day?.activities.find(a => a.id === actId);
            if(act) {
                if(!act.subItems) act.subItems = [];
                act.subItems.push({ id: crypto.randomUUID(), text, checked: false });
                saveToCloud();
                document.getElementById(`new-sub-${actId}`).value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                renderApp();
            }
        };
        window.deleteSubItem = (dayNum, actId, subId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const act = day?.activities.find(a => a.id === actId);
            if(act) {
                act.subItems = act.subItems.filter(s => s.id !== subId);
                saveToCloud();
                renderApp();
            }
        };

        // Activities
        window.deleteActivity = (dayNum, actId, title) => {
            if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${title}ã€ï¼Ÿ`)) {
                const day = itinerary.find(d => d.day === dayNum);
                if(day) {
                    day.activities = day.activities.filter(a => a.id !== actId);
                    saveToCloud();
                    renderApp();
                }
            }
        };

        // Modals - Keep existing logic for Add/Edit Activity/Notes
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        window.closeModal = (e) => {
            if(e && e.target !== modalBackdrop) return;
            modalBackdrop.classList.remove('open');
            tempImageBase64 = '';
            setTimeout(() => { modalContent.innerHTML = ''; }, 300);
        };
        const openModal = (html) => { modalContent.innerHTML = html; lucide.createIcons(); modalBackdrop.classList.add('open'); };

        window.showEditNotesModal = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const act = day?.activities.find(a => a.id === actId);
            if(!act) return;
            openModal(`
                <h3 class="font-bold text-lg mb-2">ç·¨è¼¯å‚™è¨»</h3>
                <div class="mb-2 text-xs text-gray-500">æ”¯æ´è²¼ä¸Šç¶²å€æˆ– [åç¨±](ç¶²å€) èªæ³•</div>
                <textarea id="note-text" class="w-full p-2 border rounded h-32">${act.notes || ''}</textarea>
                <div class="flex justify-end mt-4 gap-2">
                    <button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button onclick="window.saveNote(${dayNum}, '${actId}')" class="px-3 py-1 bg-rose-500 text-white rounded">å„²å­˜</button>
                </div>
            `);
        };
        window.saveNote = (dayNum, actId) => {
            const day = itinerary.find(d => d.day === dayNum);
            const act = day?.activities.find(a => a.id === actId);
            if(act) {
                act.notes = document.getElementById('note-text').value;
                saveToCloud();
                window.closeModal();
                renderApp();
            }
        };

        // ... Add Activity / Edit Activity functions
        window.showAddActivityModal = (dayNum) => {
            openModal(`
                <h3 class="font-bold text-lg mb-4">æ–°å¢æ´»å‹• (Day ${dayNum})</h3>
                <div class="space-y-3">
                    <input type="text" id="add-title" placeholder="æ¨™é¡Œ" class="w-full border p-2 rounded">
                    <input type="time" id="add-time" value="12:00" class="w-full border p-2 rounded">
                    <select id="add-type" class="w-full border p-2 rounded">
                        <option value="sightseeing">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shopping">è³¼ç‰©</option><option value="transport">äº¤é€š</option>
                        <option value="ferry">æ¸¡è¼ª</option><option value="plane">é£›æ©Ÿ</option><option value="hotel">ä½å®¿</option><option value="activity">å…¶ä»–æ´»å‹•</option>
                    </select>
                    <input type="text" id="add-desc" placeholder="ç°¡çŸ­æè¿°" class="w-full border p-2 rounded">
                </div>
                <div class="flex justify-end mt-4 gap-2">
                    <button onclick="window.closeModal()" class="px-3 py-1 bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button onclick="window.performAddActivity(${dayNum})" class="px-3 py-1 bg-rose-500 text-white rounded">æ–°å¢</button>
                </div>
            `);
        };
        window.performAddActivity = (dayNum) => {
            const title = document.getElementById('add-title').value;
            if(!title) return;
            const day = itinerary.find(d => d.day === dayNum);
            if(day) {
                day.activities.push({
                    id: crypto.randomUUID(),
                    time: document.getElementById('add-time').value,
                    title: title,
                    type: document.getElementById('add-type').value,
                    description: document.getElementById('add-desc').value,
                    mapQuery: title,
                    subItems: [],
                    notes: '',
                    image: ''
                });
                day.activities.sort((a,b)=>a.time.localeCompare(b.time));
                saveToCloud();
                window.closeModal();
                renderApp();
            }
        };

        // Start
        initApp();

    </script>
</body>
</html>

